{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>회원 상세 정보</h4>
                <a href="{{ url_for('members') }}" class="btn btn-outline-secondary btn-sm">목록으로</a>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <tr>
                        <th class="bg-light" style="width: 30%;">회원명</th>
                        <td>{{ member.member_name }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light">전화번호</th>
                        <td>{{ member.phone }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light">결제수단</th>
                        <td>{{ member.payment_method }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light">세션 수</th>
                        <td>{{ member.sessions }}회</td>
                    </tr>
                    <tr>
                        <th class="bg-light">단가</th>
                        <td>{{ "{:,}".format(member.unit_price) }}원</td>
                    </tr>
                    <tr>
                        <th class="bg-light">총 금액</th>
                        <td><strong>{{ "{:,}".format(member.sessions * member.unit_price) }}원</strong></td>
                    </tr>
                    <tr>
                        <th class="bg-light">경로</th>
                        <td>
                            <span class="badge
                                {% if member.channel == 'WI' %}bg-primary
                                {% elif member.channel == 'OT' %}bg-success
                                {% elif member.channel == '재등록' %}bg-warning
                                {% else %}bg-info{% endif %}">
                                {{ member.channel }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th class="bg-light">담당 트레이너</th>
                        <td>{{ member.trainer.name if member.trainer else '-' }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light">등록일</th>
                        <td>{{ member.created_at[:10] }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light">상태</th>
                        <td>
                            {% if member.refund_status == 'refunded' %}
                            <span class="badge bg-danger">환불 처리됨</span>
                            {% if member.refund_amount and member.refund_amount > 0 %}
                            <br><small class="text-muted">차감액: {{ "{:,}".format(member.refund_amount|int) }}원</small>
                            <br><small class="text-muted">적용월: {{ member.refund_applied_month }}</small>
                            {% elif member.original_sessions %}
                            <br><small class="text-muted">완료: {{ member.sessions }}회 / 원래: {{ member.original_sessions }}회</small>
                            {% else %}
                            <br><small class="text-muted">동월 등록 - 계약금액 제외</small>
                            {% endif %}
                            {% elif member.transfer_status == 'transferred' %}
                            <span class="badge bg-warning text-dark">인계됨</span>
                            <br><small class="text-muted">완료: {{ member.sessions }}회 / 원래: {{ member.original_sessions }}회</small>
                            <br><small class="text-muted">인계: {{ member.transferred_sessions }}회</small>
                            {% elif member.transfer_status == 'received' %}
                            <span class="badge bg-info">인계받음</span>
                            <br><small class="text-muted">인계받은 세션: {{ member.sessions }}회</small>
                            {% else %}
                            <span class="badge bg-success">정상</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>

                <!-- Actions -->
                <div class="mt-4 d-flex gap-2 flex-wrap">
                    {% if member.refund_status != 'refunded' and member.transfer_status != 'transferred' %}
                    <!-- Transfer Button -->
                    <a href="{{ url_for('transfer_member', member_id=member.id) }}" class="btn btn-info">
                        <i class="bi bi-arrow-right-circle"></i> 회원 인계
                    </a>

                    <!-- Refund Button -->
                    <form method="POST" action="{{ url_for('refund_member', member_id=member.id) }}" class="d-inline"
                          onsubmit="return confirm('정말 이 회원을 환불 처리하시겠습니까?\n\n환불 처리 시:\n- 완료된 수업만 매출에 반영됩니다.\n- 이전 달 등록 회원인 경우, 인센티브 차액이 이번 달 급여에서 차감됩니다.');">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-counterclockwise"></i> 회원 환불
                        </button>
                    </form>

                    {% elif member.refund_status == 'refunded' %}
                    {% if user.role == 'main_admin' %}
                    <form method="POST" action="{{ url_for('cancel_refund', member_id=member.id) }}" class="d-inline"
                          onsubmit="return confirm('환불을 취소하시겠습니까?\n\n환불 취소 시 해당 회원의 계약금액이 다시 매출에 포함됩니다.');">
                        <button type="submit" class="btn btn-outline-success">
                            <i class="bi bi-arrow-repeat"></i> 환불 취소
                        </button>
                    </form>
                    {% else %}
                    <p class="text-muted mb-0"><small>환불 취소는 최고관리자만 가능합니다.</small></p>
                    {% endif %}

                    {% elif member.transfer_status == 'transferred' %}
                    <p class="text-muted mb-0"><small>인계된 회원입니다.</small></p>
                    {% endif %}
                </div>

                {% if member.signature %}
                <div class="mt-4">
                    <h5>회원 서명</h5>
                    <div class="border rounded p-3 bg-light">
                        <img src="{{ member.signature }}" alt="회원 서명" class="img-fluid" style="max-height: 150px;">
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
