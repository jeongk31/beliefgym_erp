{% extends 'base.html' %}

{% block content %}
<div class="schedule-header d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">스케줄 관리</h2>
    {% if user.role == 'trainer' or selected_trainer_id %}
    <div class="d-flex gap-1 schedule-action-btns">
        <button type="button" class="btn btn-sm btn-primary" id="addModeBtn" onclick="enterAddMode()">
            <i class="bi bi-plus-lg d-md-none"></i>
            <span class="d-none d-md-inline">+ 추가</span>
            <span class="d-md-none">추가</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger" id="deleteModeBtn" onclick="enterDeleteMode()">
            <i class="bi bi-dash-lg d-md-none"></i>
            <span class="d-none d-md-inline">- 삭제</span>
            <span class="d-md-none">삭제</span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="editModeBtn" onclick="enterEditMode()">
            <i class="bi bi-arrows-move d-md-none"></i>
            <span class="d-none d-md-inline">이동</span>
            <span class="d-md-none">이동</span>
        </button>
    </div>
    {% endif %}
</div>

{% if user.role == 'trainer' or selected_trainer_id %}
<!-- Status Legend -->
<div class="mb-3 status-legend">
    <span class="badge bg-warning text-dark">수업 계획</span>
    <span class="badge bg-info">서명 대기</span>
    <span class="badge bg-success">수업 완료</span>
    <span class="badge bg-danger">수업 취소</span>
</div>

<!-- Add Mode Panel (Hidden by default) -->
<div class="card mb-3 border-primary" id="addModePanel" style="display: none;">
    <div class="card-body py-3">
        <div class="row align-items-center">
            <div class="col-auto">
                <span class="badge bg-primary fs-6">스케줄 추가 모드</span>
            </div>
            <div class="col-md-4">
                <select id="selectedMember" class="form-select">
                    <option value="">-- 회원 선택 --</option>
                    {% for member in members %}
                    <option value="{{ member.id }}">{{ member.display_name or member.member_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto" id="addModeIndicator" style="display: none;">
                <span class="text-primary fw-bold">
                    <span id="selectedMemberName"></span> - 시간대를 클릭하여 추가
                </span>
            </div>
            <div class="col-auto ms-auto">
                <button type="button" class="btn btn-secondary" onclick="exitMode()">완료</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Mode Panel (Hidden by default) -->
<div class="card mb-3 border-danger" id="deleteModePanel" style="display: none;">
    <div class="card-body py-3">
        <div class="row align-items-center">
            <div class="col-auto">
                <span class="badge bg-danger fs-6">스케줄 삭제 모드</span>
            </div>
            <div class="col">
                <span class="text-danger">삭제할 스케줄을 클릭하세요 (지난 수업은 삭제할 수 없습니다)</span>
            </div>
            <div class="col-auto ms-auto">
                <button type="button" class="btn btn-secondary" onclick="exitMode()">완료</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit/Move Mode Panel (Hidden by default) -->
<div class="card mb-3 border-secondary" id="editModePanel" style="display: none;">
    <div class="card-body py-3">
        <div class="row align-items-center">
            <div class="col-auto">
                <span class="badge bg-secondary fs-6">스케줄 이동 모드</span>
            </div>
            <div class="col">
                <span class="text-secondary">스케줄을 드래그하여 이동하세요 (계획 상태만 가능)</span>
            </div>
            <div class="col-auto ms-auto">
                <button type="button" class="btn btn-secondary" onclick="exitMode()">완료</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- OT Assignments Panel (for trainers) -->
{% if user.role == 'trainer' and ot_assignments %}
<div class="ot-panel rounded mb-3 px-3 py-2 d-flex align-items-center" style="background-color: #475569; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
    <span class="text-white fw-bold me-3 flex-shrink-0" style="font-size: 0.9rem;">
        <i class="bi bi-people-fill me-1"></i>OT 배정
    </span>
    <div class="d-flex align-items-stretch gap-2 flex-nowrap overflow-auto py-1" style="scrollbar-width: thin;">
        {% for ot in ot_assignments %}
        <div class="ot-assignment-card d-flex flex-column align-items-center px-3 py-2 rounded flex-shrink-0 {% if ot.days_remaining is not none and ot.days_remaining < 2 %}ot-urgent{% elif ot.days_remaining is not none and ot.days_remaining < 5 %}ot-warning{% else %}ot-normal{% endif %}"
             data-assignment-id="{{ ot.id }}"
             data-member-id="{{ ot.member.id }}"
             data-member-name="{{ ot.member.member_name }}"
             data-session-number="{{ ot.session_number }}"
             data-extended="{{ 'true' if ot.extended else 'false' }}"
             onclick="selectOtAssignment(this)"
             style="cursor: pointer; min-width: 70px;">
            <span class="fw-bold text-dark" style="font-size: 0.8rem;">{{ ot.member.member_name }}</span>
            <div class="d-flex align-items-center gap-1 mt-1" style="font-size: 0.65rem;">
                <span class="badge" style="font-size: 0.6rem; padding: 2px 6px; {% if ot.session_number == 1 %}background-color: #276749;{% elif ot.session_number == 2 %}background-color: #1a365d;{% else %}background-color: #c05621;{% endif %} color: white;">
                    {{ ot.session_number }}차
                </span>
                {% if ot.days_remaining is not none %}
                <span class="{% if ot.days_remaining < 2 %}text-danger fw-bold{% elif ot.days_remaining < 5 %}text-warning{% else %}text-success{% endif %}" style="font-size: 0.65rem;">
                    {% if ot.days_remaining < 0 %}{{ ot.days_remaining|abs }}일↑{% elif ot.days_remaining == 0 %}오늘{% else %}{{ ot.days_remaining }}일{% endif %}
                </span>
                {% endif %}
                {% if ot.extended %}<span class="badge" style="font-size: 0.55rem; padding: 1px 4px; background-color: #4a5568; color: white;">연장</span>{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- OT Add Mode Panel (Hidden by default) -->
{% if user.role == 'trainer' %}
<div class="card mb-3" id="otAddModePanel" style="display: none; border: 2px solid #0369a1;">
    <div class="card-body py-3" style="background-color: #f0f9ff;">
        <div class="row align-items-center">
            <div class="col-auto">
                <span class="badge fs-6" style="background-color: #0369a1; color: white;">OT 스케줄 추가 모드</span>
            </div>
            <div class="col-auto" id="otAddModeIndicator">
                <span class="fw-bold" style="color: #0369a1;">
                    <span id="selectedOtMemberName">OT 회원을 선택하세요</span>
                </span>
            </div>
            <div class="col-auto ms-auto">
                <button type="button" class="btn btn-secondary" onclick="exitMode()">완료</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Week Navigation & Filters - All in one row -->
<div class="card mb-3 week-nav-card">
    <div class="card-body py-2">
        <form method="GET" id="scheduleFilterForm" class="row align-items-center g-2">
            <!-- Week Navigation -->
            <div class="col-auto">
                <div class="d-flex align-items-center gap-1">
                    <a href="#" class="btn btn-outline-secondary btn-sm px-2" id="prevWeekBtn">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    <a href="{{ url_for('schedule', trainer_id=selected_trainer_id or '', branch_id=filter_branch_id or '') }}" class="btn btn-outline-primary btn-sm">오늘</a>
                    <span class="fw-bold text-primary mx-1 week-date-display">
                        {{ week_days[0].date[5:7] }}월 {{ week_days[0].day_num }}일 - {{ week_days[6].day_num }}일
                    </span>
                    <a href="#" class="btn btn-outline-secondary btn-sm px-2" id="nextWeekBtn">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>

            {% if user.role in ['main_admin', 'branch_admin'] %}
            <!-- Branch Filter (main_admin only) - hidden on mobile -->
            {% if user.role == 'main_admin' %}
            <div class="col-auto branch-filter">
                <label class="col-form-label ms-2">지점:</label>
            </div>
            <div class="col-auto branch-filter">
                <select name="branch_id" class="form-select form-select-sm" onchange="filterByBranch(this.value)">
                    <option value="">전체</option>
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if filter_branch_id == branch.id %}selected{% endif %}>
                        {{ branch.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Trainer Filter -->
            <div class="col-auto">
                <label class="col-form-label {% if user.role != 'main_admin' %}ms-2{% endif %}">트레이너:</label>
            </div>
            <div class="col-auto">
                <select name="trainer_id" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">선택</option>
                    {% for trainer in trainers %}
                    <option value="{{ trainer.id }}" {% if selected_trainer_id == trainer.id %}selected{% endif %}>
                        {{ trainer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <input type="hidden" name="date" value="{{ selected_date }}">
        </form>
    </div>
</div>

<!-- Timetable Grid -->
{% if user.role == 'trainer' or selected_trainer_id %}
<div class="card schedule-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered mb-0 schedule-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 80px;" class="text-center">시간</th>
                        {% for day in week_days %}
                        <th class="text-center {% if day.is_today %}bg-primary text-white{% endif %}">
                            {{ day.day_name }}<br>
                            <small>{{ day.day_num }}일</small>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for time_slot in time_slots %}
                    <tr>
                        <td class="text-center align-middle bg-light">
                            <strong>{{ time_slot }}</strong>
                        </td>
                        {% for day in week_days %}
                        {% set schedule = schedule_grid[day.date][time_slot] %}
                        {% set status = schedule.status if schedule and schedule.status else '수업 계획' %}
                        {% set is_locked = (status in ['수업 완료', '수업 취소', '트레이너 확인']) or (day.date < selected_date) %}
                        <td class="schedule-cell {% if schedule %}has-schedule status-{{ 'planned' if status == '수업 계획' else 'confirmed' if status == '트레이너 확인' else 'completed' if status == '수업 완료' else 'cancelled' }}{% endif %}"
                            data-date="{{ day.date }}" data-time="{{ time_slot }}"
                            {% if schedule %}data-schedule-id="{{ schedule.id }}" data-status="{{ status }}" data-is-past="{{ 'true' if day.date < selected_date else 'false' }}" data-is-locked="{{ 'true' if is_locked else 'false' }}"{% endif %}>
                            {% if schedule %}
                            <div class="schedule-item {% if status == '수업 계획' %}clickable{% endif %}"
                                 draggable="false"
                                 data-schedule-id="{{ schedule.id }}"
                                 data-member-name="{{ schedule.member.display_name or schedule.member.member_name }}"
                                 data-schedule-date="{{ schedule.schedule_date }}"
                                 data-start-time="{{ schedule.start_time[:5] }}"
                                 data-end-time="{{ schedule.end_time[:5] }}"
                                 data-status="{{ status }}"
                                 data-work-type="{{ schedule.work_type or '' }}"
                                 onclick="if (!document.body.classList.contains('add-mode') && !document.body.classList.contains('delete-mode') && !document.body.classList.contains('edit-mode') && '{{ status }}' === '수업 계획') { handleScheduleClick(this); }">
                                <div class="schedule-name">{{ schedule.member.display_name or schedule.member.member_name }}</div>
                                <div class="schedule-badges">
                                    <span class="schedule-status {% if status == '수업 계획' %}status-planned{% elif status == '트레이너 확인' %}status-confirmed{% elif status == '수업 완료' %}status-completed{% else %}status-cancelled{% endif %}">
                                        {% if status == '수업 계획' %}계획{% elif status == '트레이너 확인' %}서명{% elif status == '수업 완료' %}완료{% else %}취소{% endif %}
                                    </span>
                                    {% if schedule.work_type %}
                                    <span class="schedule-work-type">{{ 'M' if schedule.work_type == '근무내' else '외' }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Delete overlay for delete mode -->
                            <div class="delete-overlay" onclick="deleteSchedule('{{ schedule.id }}', '{{ day.date }}')">
                                <span class="delete-icon">X</span>
                            </div>
                            {% else %}
                            <div class="empty-slot" onclick="addScheduleToSlot(this)">
                                <span class="add-hint">+</span>
                            </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Mobile scroll hint -->
        <div class="scroll-hint d-md-none">
            <i class="bi bi-arrow-left-right"></i> 좌우로 스크롤하세요
        </div>
    </div>
</div>
{% else %}
<!-- No trainer selected message for admins -->
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-person-badge fs-1 text-muted"></i>
        <h5 class="mt-3 text-muted">트레이너를 선택해주세요</h5>
        <p class="text-muted">스케줄을 보려면 위에서 트레이너를 선택하세요.</p>
    </div>
</div>
{% endif %}

<style>
/* OT Panel styling */
.ot-assignment-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
}
.ot-assignment-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.ot-assignment-card.selected {
    box-shadow: 0 0 0 3px #0369a1, 0 4px 12px rgba(0,0,0,0.15);
    border-color: #0369a1;
}
.ot-assignment-card.ot-urgent {
    background-color: #fef2f2;
    border-color: #fecaca;
}
.ot-assignment-card.ot-warning {
    background-color: #fffbeb;
    border-color: #fde68a;
}
.ot-assignment-card.ot-normal {
    background-color: #f0fdf4;
    border-color: #bbf7d0;
}
.overflow-auto::-webkit-scrollbar {
    height: 4px;
}
.overflow-auto::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
}
.overflow-auto::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.5);
    border-radius: 4px;
}

.schedule-table {
    table-layout: fixed;
}
.schedule-table th, .schedule-table td {
    vertical-align: middle;
}
.schedule-cell {
    height: 60px;
    position: relative;
    transition: background-color 0.2s;
    padding: 1px !important;
}
.schedule-cell:hover {
    background-color: #f8f9fa;
}
.schedule-cell.status-planned {
    background-color: #fff3cd;
}
.schedule-cell.status-confirmed {
    background-color: #cfe2ff;
}
.schedule-cell.status-completed {
    background-color: #d1e7dd;
}
.schedule-cell.status-cancelled {
    background-color: #f8d7da;
}
/* Schedule item styling */
.schedule-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 4px 2px;
    text-align: center;
}
.schedule-name {
    font-size: 0.75rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 3px;
    line-height: 1.2;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.schedule-badges {
    display: flex;
    gap: 3px;
    justify-content: center;
    align-items: center;
}
.schedule-status {
    font-size: 0.6rem;
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 3px;
    letter-spacing: -0.3px;
}
.schedule-status.status-planned {
    background-color: #ffc107;
    color: #000;
}
.schedule-status.status-completed {
    background-color: #198754;
    color: #fff;
}
.schedule-status.status-cancelled {
    background-color: #dc3545;
    color: #fff;
}
.schedule-work-type {
    font-size: 0.55rem;
    font-weight: 600;
    padding: 2px 4px;
    border-radius: 3px;
    background-color: #6c757d;
    color: #fff;
}
.schedule-cell {
    position: relative;
}
/* Edit mode styling */
body.edit-mode .schedule-cell.has-schedule .schedule-item {
    cursor: pointer;
}
body.edit-mode .schedule-cell.has-schedule:hover {
    outline: 2px solid #6c757d;
    outline-offset: -2px;
}
.empty-slot {
    width: 100%;
    height: 100%;
    min-height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.empty-slot .add-hint {
    display: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #0d6efd;
    color: white;
    line-height: 30px;
    text-align: center;
    font-size: 1.2rem;
}
/* Add mode styling */
body.add-mode .schedule-cell:not(.has-schedule) {
    background-color: #e7f1ff;
    cursor: pointer;
}
body.add-mode .schedule-cell:not(.has-schedule):hover {
    background-color: #cfe2ff;
}
body.add-mode .schedule-cell:not(.has-schedule) .add-hint {
    display: block;
}
/* Delete mode styling */
.delete-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(220, 53, 69, 0.8);
    cursor: pointer;
    justify-content: center;
    align-items: center;
    z-index: 10;
}
.delete-overlay .delete-icon {
    color: white;
    font-size: 2rem;
    font-weight: bold;
}
/* For admin (main_admin or branch_admin): can delete any schedule */
body.delete-mode.is-admin .schedule-cell.has-schedule .delete-overlay {
    display: flex;
}
body.delete-mode.is-admin .schedule-cell.has-schedule:hover .delete-overlay {
    background: rgba(220, 53, 69, 0.95);
}
/* For non-admin: can only delete unlocked (planned & not past) schedules */
body.delete-mode:not(.is-admin) .schedule-cell.has-schedule:not([data-is-locked="true"]) .delete-overlay {
    display: flex;
}
body.delete-mode:not(.is-admin) .schedule-cell.has-schedule:not([data-is-locked="true"]):hover .delete-overlay {
    background: rgba(220, 53, 69, 0.95);
}
body.delete-mode:not(.is-admin) .schedule-cell.has-schedule[data-is-locked="true"] {
    opacity: 0.5;
}
/* Clickable schedule item */
.schedule-item.clickable {
    cursor: pointer;
    transition: background-color 0.2s;
}
.schedule-item.clickable:hover {
    background-color: rgba(0, 123, 255, 0.1);
    border-radius: 4px;
}
/* Hide clickable cursor in add/delete mode */
body.add-mode .schedule-item.clickable,
body.delete-mode .schedule-item.clickable {
    pointer-events: none;
}
/* Loading state */
.schedule-cell.loading {
    opacity: 0.5;
    pointer-events: none;
}
.schedule-cell.loading::after {
    content: "...";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 20;
}

/* ========== DRAG AND DROP STYLES ========== */
.schedule-item.draggable {
    cursor: grab;
}
.schedule-item.draggable:active {
    cursor: grabbing;
}
.schedule-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
}
.schedule-cell.drop-target {
    background-color: #e7f3ff !important;
    border: 2px dashed #0d6efd !important;
}
.schedule-cell.drag-over {
    background-color: #cfe2ff !important;
    border: 2px solid #0d6efd !important;
}
/* Hide drag in add/delete/edit mode */
body.add-mode .schedule-item.draggable,
body.delete-mode .schedule-item.draggable,
body.edit-mode .schedule-item.draggable {
    cursor: pointer;
}

/* ========== MOBILE RESPONSIVE STYLES ========== */
@media (max-width: 768px) {
    /* Header - compact with small buttons in corner */
    .schedule-header {
        flex-direction: row;
        gap: 8px;
        margin-bottom: 8px !important;
    }
    .schedule-header h2 {
        font-size: 1.2rem;
        margin: 0;
    }
    .schedule-action-btns {
        width: auto;
    }
    .schedule-action-btns .btn {
        padding: 4px 8px;
        font-size: 0.7rem;
    }

    /* Hide status legend on mobile */
    .status-legend {
        display: none;
    }

    /* Week Navigation Card - Compact */
    .week-nav-card .card-body {
        padding: 6px !important;
    }
    .week-nav-card .row {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: center;
    }
    .week-nav-card .col-auto {
        width: auto;
    }
    .week-nav-card .d-flex {
        justify-content: center;
        gap: 4px !important;
    }
    .week-nav-card label {
        display: none;
    }
    /* Hide branch filter on mobile - only show trainer */
    .week-nav-card .branch-filter {
        display: none !important;
    }
    .week-nav-card select {
        width: auto;
        min-width: 80px;
        font-size: 0.75rem;
        padding: 4px 6px;
    }
    .week-nav-card .btn {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    .week-date-display {
        font-size: 0.75rem;
    }

    /* Mode Panels - Compact */
    #addModePanel .card-body,
    #deleteModePanel .card-body,
    #editModePanel .card-body {
        padding: 8px !important;
    }
    #addModePanel .row,
    #deleteModePanel .row,
    #editModePanel .row {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 6px;
    }
    #addModePanel .row > div,
    #deleteModePanel .row > div,
    #editModePanel .row > div {
        width: auto;
        margin: 0 !important;
    }
    #addModePanel .badge,
    #deleteModePanel .badge,
    #editModePanel .badge {
        font-size: 0.7rem !important;
        padding: 4px 8px;
    }
    #addModePanel select {
        font-size: 0.75rem;
        padding: 4px 6px;
    }
    #addModePanel .col-auto:last-child .btn,
    #deleteModePanel .col-auto:last-child .btn,
    #editModePanel .col-auto:last-child .btn {
        width: auto;
        padding: 4px 12px;
        font-size: 0.75rem;
    }
    #addModeIndicator {
        display: none !important;
    }
    #deleteModePanel .col,
    #editModePanel .col {
        display: none;
    }

    /* Schedule Table Container - No scroll */
    .schedule-card {
        margin-bottom: 20px;
    }
    .table-responsive {
        overflow-x: hidden;
    }

    /* Hide scroll hint on mobile */
    .scroll-hint {
        display: none;
    }

    /* Schedule Table - Fit to screen */
    .schedule-table {
        min-width: auto;
        width: 100%;
        table-layout: fixed;
    }
    .schedule-table thead th:first-child,
    .schedule-table tbody td:first-child {
        position: static;
        box-shadow: none;
    }
    .schedule-table th {
        font-size: 0.55rem;
        padding: 3px 1px;
        min-width: auto;
    }
    .schedule-table th:first-child {
        min-width: auto;
        width: 24px;
    }
    /* Time column font size */
    .schedule-table td:first-child {
        font-size: 0.55rem;
        padding: 2px 1px !important;
        width: 24px;
    }
    .schedule-table td:first-child strong {
        font-size: 0.55rem;
        font-weight: 600;
    }

    /* Schedule cells - Compact */
    .schedule-cell {
        height: 48px;
        min-width: auto;
        padding: 1px !important;
    }
    .schedule-item {
        padding: 2px 1px;
    }
    .schedule-name {
        font-size: 0.55rem;
        max-width: 100%;
        margin-bottom: 1px;
    }
    .schedule-badges {
        gap: 1px;
    }
    .schedule-status {
        font-size: 0.45rem;
        padding: 1px 3px;
    }
    .schedule-work-type {
        font-size: 0.4rem;
        padding: 1px 2px;
    }

    /* Empty slot */
    .empty-slot {
        min-height: 35px;
    }
    .empty-slot .add-hint {
        width: 20px;
        height: 20px;
        line-height: 20px;
        font-size: 0.9rem;
    }

    /* Delete overlay */
    .delete-overlay .delete-icon {
        font-size: 1.2rem;
    }
}

/* Extra small devices */
@media (max-width: 480px) {
    .schedule-header h2 {
        font-size: 1rem;
    }
    .schedule-action-btns .btn {
        padding: 3px 6px;
        font-size: 0.65rem;
    }
    .week-nav-card .btn {
        padding: 3px 6px;
        font-size: 0.65rem;
    }
    .week-date-display {
        font-size: 0.65rem;
    }
    .week-nav-card select {
        min-width: 70px;
        font-size: 0.65rem;
        padding: 3px 4px;
    }
    .schedule-table th {
        font-size: 0.5rem;
        padding: 2px 1px;
    }
    .schedule-table th:first-child {
        width: 20px;
    }
    .schedule-table td:first-child {
        font-size: 0.5rem;
        width: 20px;
    }
    .schedule-table td:first-child strong {
        font-size: 0.5rem;
    }
    .schedule-cell {
        height: 44px;
    }
    .schedule-name {
        font-size: 0.5rem;
        margin-bottom: 1px;
    }
    .schedule-status {
        font-size: 0.4rem;
        padding: 1px 2px;
    }
    .schedule-work-type {
        font-size: 0.35rem;
        padding: 1px 2px;
    }
    .empty-slot {
        min-height: 32px;
    }
    .empty-slot .add-hint {
        width: 18px;
        height: 18px;
        line-height: 18px;
        font-size: 0.8rem;
    }
}
</style>

<script>
const todayDate = '{{ selected_date }}';
const userRole = '{{ user.role }}';
const isMainAdmin = userRole === 'main_admin';
const isAdmin = userRole === 'main_admin' || userRole === 'branch_admin';
const selectedTrainerId = '{{ selected_trainer_id or "" }}';
const filterBranchId = '{{ filter_branch_id or "" }}';

// Working hours for auto work type classification on weekdays
const trainerWorkingHours = {
    start: '{{ trainer_working_hours.start or "" }}',
    end: '{{ trainer_working_hours.end or "" }}'
};

// Holidays for the current week (treated like weekends)
const weekHolidays = {{ week_holidays | tojson }};

function filterByBranch(branchId) {
    // When branch changes, clear trainer selection and reload
    const url = new URL(window.location);
    url.searchParams.set('branch_id', branchId);
    url.searchParams.delete('trainer_id'); // Reset trainer when branch changes
    window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
    // Add admin class to body for CSS targeting
    if (isMainAdmin) {
        document.body.classList.add('is-main-admin');
    }
    if (isAdmin) {
        document.body.classList.add('is-admin');
    }

    const weekStart = new Date('{{ week_start }}');

    // Build query params
    let params = '';
    if (selectedTrainerId) params += '&trainer_id=' + selectedTrainerId;
    if (filterBranchId) params += '&branch_id=' + filterBranchId;

    // Previous week
    document.getElementById('prevWeekBtn').href = '{{ url_for("schedule") }}?date=' +
        new Date(weekStart.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] + params;

    // Next week
    document.getElementById('nextWeekBtn').href = '{{ url_for("schedule") }}?date=' +
        new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] + params;

    // Member selection change
    document.getElementById('selectedMember').addEventListener('change', function() {
        const memberId = this.value;
        const memberName = this.options[this.selectedIndex].text;
        const indicator = document.getElementById('addModeIndicator');
        const nameSpan = document.getElementById('selectedMemberName');

        if (memberId) {
            indicator.style.display = 'inline-block';
            nameSpan.textContent = memberName;
            // Save to sessionStorage
            sessionStorage.setItem('selectedMemberId', memberId);
            sessionStorage.setItem('selectedMemberName', memberName);
        } else {
            indicator.style.display = 'none';
            sessionStorage.removeItem('selectedMemberId');
            sessionStorage.removeItem('selectedMemberName');
        }
    });

    // Restore mode from sessionStorage after page reload
    const savedMode = sessionStorage.getItem('scheduleMode');
    if (savedMode === 'add') {
        enterAddMode(true); // true = restoring
        const savedMemberId = sessionStorage.getItem('selectedMemberId');
        const savedMemberName = sessionStorage.getItem('selectedMemberName');
        if (savedMemberId) {
            document.getElementById('selectedMember').value = savedMemberId;
            document.getElementById('addModeIndicator').style.display = 'inline-block';
            document.getElementById('selectedMemberName').textContent = savedMemberName;
        }
    } else if (savedMode === 'delete') {
        enterDeleteMode(true); // true = restoring
    } else if (savedMode === 'edit') {
        enterEditMode(true); // true = restoring
    }
});

function enterAddMode(restoring = false) {
    exitMode(true); // silent exit
    document.body.classList.add('add-mode');
    document.getElementById('addModePanel').style.display = 'block';
    document.getElementById('addModeBtn').classList.add('active');
    if (!restoring) {
        sessionStorage.setItem('scheduleMode', 'add');
    }
}

function enterDeleteMode(restoring = false) {
    exitMode(true); // silent exit
    document.body.classList.add('delete-mode');
    document.getElementById('deleteModePanel').style.display = 'block';
    document.getElementById('deleteModeBtn').classList.add('active');
    if (!restoring) {
        sessionStorage.setItem('scheduleMode', 'delete');
    }
}

function enterEditMode(restoring = false) {
    exitMode(true); // silent exit
    document.body.classList.add('edit-mode');
    const editPanel = document.getElementById('editModePanel');
    if (editPanel) editPanel.style.display = 'block';
    const editBtn = document.getElementById('editModeBtn');
    if (editBtn) editBtn.classList.add('active');
    // Enable drag and drop in edit mode
    enableDragMode();
    if (!restoring) {
        sessionStorage.setItem('scheduleMode', 'edit');
    }
}

function exitMode(silent = false) {
    document.body.classList.remove('add-mode', 'delete-mode', 'edit-mode', 'ot-add-mode');
    document.getElementById('addModePanel').style.display = 'none';
    document.getElementById('deleteModePanel').style.display = 'none';
    const editPanel = document.getElementById('editModePanel');
    if (editPanel) editPanel.style.display = 'none';
    const otAddPanel = document.getElementById('otAddModePanel');
    if (otAddPanel) otAddPanel.style.display = 'none';
    document.getElementById('addModeBtn').classList.remove('active');
    document.getElementById('deleteModeBtn').classList.remove('active');
    const editBtn = document.getElementById('editModeBtn');
    if (editBtn) editBtn.classList.remove('active');
    document.getElementById('selectedMember').value = '';
    document.getElementById('addModeIndicator').style.display = 'none';
    // Disable drag and drop when exiting any mode
    disableDragMode();

    // Reset OT selection
    document.querySelectorAll('.ot-assignment-card').forEach(card => {
        card.classList.remove('selected', 'border-3');
    });
    selectedOtAssignment = null;
    const otNameSpan = document.getElementById('selectedOtMemberName');
    if (otNameSpan) otNameSpan.textContent = 'OT 회원을 선택하세요';

    if (!silent) {
        // Clear sessionStorage when user clicks 완료
        sessionStorage.removeItem('scheduleMode');
        sessionStorage.removeItem('selectedMemberId');
        sessionStorage.removeItem('selectedMemberName');
        sessionStorage.removeItem('selectedOtAssignmentId');
    }
}

// OT Scheduling
let selectedOtAssignment = null;

// Global flags to prevent multiple concurrent operations
let isAddingSchedule = false;
let isDeletingSchedule = false;

function enterOtAddMode() {
    exitMode(true);
    document.body.classList.add('ot-add-mode');
    const otAddPanel = document.getElementById('otAddModePanel');
    if (otAddPanel) otAddPanel.style.display = 'block';
    sessionStorage.setItem('scheduleMode', 'ot-add');
}

function selectOtAssignment(element) {
    // If already in OT add mode, just select the assignment
    if (document.body.classList.contains('ot-add-mode')) {
        doSelectOtAssignment(element);
        return;
    }

    // Otherwise, show the option modal first
    const assignmentId = element.dataset.assignmentId;
    const memberName = element.dataset.memberName;
    const sessionNumber = element.dataset.sessionNumber;
    const extended = element.dataset.extended === 'true';

    // Store the element for later
    window.pendingOtElement = element;

    // Populate the modal
    document.getElementById('otOptionMemberName').textContent = memberName;
    document.getElementById('otOptionSessionNumber').textContent = sessionNumber + '차';

    // Disable extend button if already extended
    const extendBtn = document.getElementById('otOptionExtendBtn');
    if (extended) {
        extendBtn.disabled = true;
        extendBtn.innerHTML = '<i class="bi bi-calendar-check me-2"></i>이미 연장됨';
    } else {
        extendBtn.disabled = false;
        extendBtn.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>1주일 연기하기';
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('otOptionModal'));
    modal.show();
}

function doSelectOtAssignment(element) {
    // Remove previous selection
    document.querySelectorAll('.ot-assignment-card').forEach(card => {
        card.classList.remove('selected', 'border-3');
    });

    // Select this one
    element.classList.add('selected', 'border-3');
    selectedOtAssignment = {
        assignmentId: element.dataset.assignmentId,
        memberId: element.dataset.memberId,
        memberName: element.dataset.memberName,
        sessionNumber: element.dataset.sessionNumber
    };

    // Update indicator
    const otNameSpan = document.getElementById('selectedOtMemberName');
    if (otNameSpan) {
        otNameSpan.textContent = `${selectedOtAssignment.memberName} (OT ${selectedOtAssignment.sessionNumber}차) - 시간대를 클릭하여 추가`;
    }

    sessionStorage.setItem('selectedOtAssignmentId', selectedOtAssignment.assignmentId);
}

function otOptionSchedule() {
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('otOptionModal')).hide();

    // Enter OT add mode and select the assignment
    enterOtAddMode();
    if (window.pendingOtElement) {
        doSelectOtAssignment(window.pendingOtElement);
        window.pendingOtElement = null;
    }
}

function otOptionExtend() {
    const element = window.pendingOtElement;
    if (!element) return;

    const assignmentId = element.dataset.assignmentId;
    const btn = document.getElementById('otOptionExtendBtn');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>처리 중...';

    fetch(`/ot-assignments/${assignmentId}/extend`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload
            bootstrap.Modal.getInstance(document.getElementById('otOptionModal')).hide();
            location.reload();
        } else {
            alert(data.error || '연장에 실패했습니다.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>1주일 연기하기';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('연장 중 오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-calendar-plus me-2"></i>1주일 연기하기';
    });
}

function addOtScheduleToSlot(element) {
    if (!document.body.classList.contains('ot-add-mode')) return;

    // Prevent multiple concurrent additions globally
    if (isAddingSchedule) {
        return;
    }

    if (!selectedOtAssignment) {
        alert('먼저 OT 회원을 선택해주세요.');
        return;
    }

    const cell = element.closest('.schedule-cell');
    const date = cell.dataset.date;
    const time = cell.dataset.time;

    // Prevent double-click on same cell
    if (cell.classList.contains('loading')) return;

    // Set global lock and cell loading state
    isAddingSchedule = true;
    cell.classList.add('loading');

    fetch('{{ url_for("quick_add_schedule") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: selectedOtAssignment.memberId,
            ot_assignment_id: selectedOtAssignment.assignmentId,
            date: date,
            time: time
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '스케줄 추가에 실패했습니다.');
            cell.classList.remove('loading');
            isAddingSchedule = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('스케줄 추가 중 오류가 발생했습니다.');
        cell.classList.remove('loading');
        isAddingSchedule = false;
    });
}

function handleScheduleClick(element) {
    // Don't do anything in add/delete mode
    if (document.body.classList.contains('add-mode') || document.body.classList.contains('delete-mode')) {
        return;
    }

    const scheduleId = element.dataset.scheduleId;
    const memberName = element.dataset.memberName;
    const scheduleDate = element.dataset.scheduleDate;
    const startTime = element.dataset.startTime;
    const endTime = element.dataset.endTime;
    const status = element.dataset.status;
    const workType = element.dataset.workType;

    // Edit mode - open edit modal (admin only)
    if (document.body.classList.contains('edit-mode') && isAdmin) {
        openEditModal(scheduleId, memberName, scheduleDate, startTime, status, workType);
        return;
    }

    // Normal mode - open complete modal only for 수업 계획 status
    if (status === '수업 계획') {
        openCompleteModal(scheduleId, memberName, scheduleDate, startTime, endTime);
    }
}

function addScheduleToSlot(element) {
    // Handle OT add mode
    if (document.body.classList.contains('ot-add-mode')) {
        addOtScheduleToSlot(element);
        return;
    }

    if (!document.body.classList.contains('add-mode')) return;

    // Prevent multiple concurrent additions globally
    if (isAddingSchedule) {
        return;
    }

    const memberId = document.getElementById('selectedMember').value;
    if (!memberId) {
        alert('먼저 회원을 선택해주세요.');
        return;
    }

    const cell = element.closest('.schedule-cell');
    const date = cell.dataset.date;
    const time = cell.dataset.time;

    // Prevent double-click on same cell
    if (cell.classList.contains('loading')) return;

    // Set global lock and cell loading state
    isAddingSchedule = true;
    cell.classList.add('loading');

    fetch('{{ url_for("quick_add_schedule") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            date: date,
            time: time
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page - mode will be restored from sessionStorage
            location.reload();
        } else {
            alert(data.error || '스케줄 추가에 실패했습니다.');
            cell.classList.remove('loading');
            isAddingSchedule = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('스케줄 추가 중 오류가 발생했습니다.');
        cell.classList.remove('loading');
        isAddingSchedule = false;
    });
}

// ===== Drag and Drop Schedule Movement (Edit Mode Only) =====
let draggedSchedule = null;

function initDragAndDrop() {
    // Set up drop targets on all cells (always ready, but drag only works in edit mode)
    document.querySelectorAll('.schedule-cell').forEach(cell => {
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragleave', handleDragLeave);
        cell.addEventListener('drop', handleDrop);
    });
}

function enableDragMode() {
    // Enable dragging for planned schedule items
    document.querySelectorAll('.schedule-item').forEach(item => {
        const status = item.dataset.status;
        if (status === '수업 계획') {
            item.setAttribute('draggable', 'true');
            item.classList.add('draggable');
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
        }
    });
}

function disableDragMode() {
    // Disable dragging for all schedule items
    document.querySelectorAll('.schedule-item').forEach(item => {
        item.setAttribute('draggable', 'false');
        item.classList.remove('draggable');
        item.removeEventListener('dragstart', handleDragStart);
        item.removeEventListener('dragend', handleDragEnd);
    });
}

function handleDragStart(e) {
    // Only allow drag in edit mode
    if (!document.body.classList.contains('edit-mode')) {
        e.preventDefault();
        return;
    }

    draggedSchedule = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.scheduleId);

    // Highlight valid drop targets (empty cells)
    setTimeout(() => {
        document.querySelectorAll('.schedule-cell:not(.has-schedule)').forEach(cell => {
            cell.classList.add('drop-target');
        });
    }, 0);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    draggedSchedule = null;

    // Remove highlights
    document.querySelectorAll('.schedule-cell').forEach(cell => {
        cell.classList.remove('drop-target', 'drag-over');
    });
}

function handleDragOver(e) {
    e.preventDefault();

    // Only allow drop on empty cells
    if (!this.classList.contains('has-schedule')) {
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
    } else {
        e.dataTransfer.dropEffect = 'none';
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    this.classList.remove('drag-over');

    // Only allow drop on empty cells
    if (this.classList.contains('has-schedule')) {
        return;
    }

    if (!draggedSchedule) return;

    const scheduleId = draggedSchedule.dataset.scheduleId;
    const newDate = this.dataset.date;
    const newTime = this.dataset.time;

    // Show loading state
    this.classList.add('loading');
    draggedSchedule.closest('.schedule-cell').classList.add('loading');

    fetch('{{ url_for("move_schedule") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            schedule_id: scheduleId,
            new_date: newDate,
            new_time: newTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '스케줄 이동에 실패했습니다.');
            this.classList.remove('loading');
            if (draggedSchedule) {
                draggedSchedule.closest('.schedule-cell').classList.remove('loading');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('스케줄 이동 중 오류가 발생했습니다.');
        this.classList.remove('loading');
        if (draggedSchedule) {
            draggedSchedule.closest('.schedule-cell').classList.remove('loading');
        }
    });
}

// Initialize drag and drop when page loads
document.addEventListener('DOMContentLoaded', initDragAndDrop);

function deleteSchedule(scheduleId, scheduleDate) {
    if (!document.body.classList.contains('delete-mode')) return;

    // Prevent multiple concurrent deletions
    if (isDeletingSchedule) {
        return;
    }

    const cell = document.querySelector(`[data-schedule-id="${scheduleId}"]`);
    const status = cell ? cell.dataset.status : '';
    const isLocked = cell ? cell.dataset.isLocked === 'true' : false;

    // Only admin can modify completed/cancelled or past schedules
    if (!isAdmin && isLocked) {
        if (status === '수업 완료' || status === '수업 취소') {
            alert('지난 수업에 대한 수정은 불가능합니다.');
        } else {
            alert('지난 스케줄은 삭제할 수 없습니다.');
        }
        return;
    }

    if (!confirm('이 스케줄을 삭제하시겠습니까?')) return;

    // Set global lock
    isDeletingSchedule = true;
    if (cell) cell.classList.add('loading');

    fetch('{{ url_for("quick_delete_schedule") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            schedule_id: scheduleId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload page - mode will be restored from sessionStorage
            location.reload();
        } else {
            alert(data.error || '스케줄 삭제에 실패했습니다.');
            if (cell) cell.classList.remove('loading');
            isDeletingSchedule = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('스케줄 삭제 중 오류가 발생했습니다.');
        if (cell) cell.classList.remove('loading');
        isDeletingSchedule = false;
    });
}

// ===== Session Complete Modal Functions =====
let currentScheduleId = null;

function isWeekday(dateStr) {
    // Check if it's a holiday first (holidays are treated like weekends)
    if (weekHolidays.includes(dateStr)) {
        return false;
    }
    const date = new Date(dateStr);
    const day = date.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday
    return day >= 1 && day <= 5; // Monday to Friday
}

function isWithinWorkingHours(scheduleTimeStr) {
    if (!trainerWorkingHours.start || !trainerWorkingHours.end) {
        return null; // Working hours not set
    }

    // Compare schedule's time with working hours
    const scheduleTime = scheduleTimeStr.substring(0, 5);
    const start = trainerWorkingHours.start.substring(0, 5);
    const end = trainerWorkingHours.end.substring(0, 5);

    return scheduleTime >= start && scheduleTime < end;
}

function openCompleteModal(scheduleId, memberName, scheduleDate, startTime, endTime) {
    // Don't open modal in add/delete mode
    if (document.body.classList.contains('add-mode') || document.body.classList.contains('delete-mode')) {
        return;
    }

    currentScheduleId = scheduleId;

    // Populate modal info
    document.getElementById('modalMemberName').textContent = memberName;
    document.getElementById('modalScheduleDate').textContent = scheduleDate;
    document.getElementById('modalScheduleTime').textContent = startTime + ' - ' + endTime;

    // Reset form
    document.querySelectorAll('input[name="modal_work_type"]').forEach(r => r.checked = false);
    document.getElementById('modal_session_notes').value = '';

    // Check if weekday for auto work type classification
    const workTypeSection = document.getElementById('workTypeSelection');
    const workTypeAuto = document.getElementById('workTypeAutoDisplay');
    const autoWorkTypeHidden = document.getElementById('autoWorkTypeHidden');

    // Reset auto work type hidden value
    if (autoWorkTypeHidden) autoWorkTypeHidden.value = '';

    if (isWeekday(scheduleDate)) {
        // Weekday: auto-determine work type based on current time and working hours
        const withinHours = isWithinWorkingHours(startTime);

        if (withinHours === null) {
            // Working hours not set - show manual selection
            workTypeSection.style.display = 'block';
            if (workTypeAuto) workTypeAuto.style.display = 'none';
        } else {
            // Working hours set - auto-determine and show read-only
            workTypeSection.style.display = 'none';
            if (workTypeAuto) {
                workTypeAuto.style.display = 'block';
                const autoType = withinHours ? '근무내' : '근무외';
                const autoLabel = withinHours ? 'Main' : '그 외';
                document.getElementById('autoWorkTypeValue').textContent = autoLabel;
                autoWorkTypeHidden.value = autoType;
            }
        }
    } else {
        // Weekend: manual selection
        workTypeSection.style.display = 'block';
        if (workTypeAuto) workTypeAuto.style.display = 'none';
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completeSessionModal'));
    modal.show();
}

function submitCompleteSession() {
    // Get work type from either manual selection or auto-determined value
    let workTypeValue = null;
    const autoWorkTypeHidden = document.getElementById('autoWorkTypeHidden');
    const manualWorkType = document.querySelector('input[name="modal_work_type"]:checked');

    if (autoWorkTypeHidden && autoWorkTypeHidden.value) {
        // Auto-determined work type (weekday with working hours set)
        workTypeValue = autoWorkTypeHidden.value;
    } else if (manualWorkType) {
        // Manual selection (weekend or working hours not set)
        workTypeValue = manualWorkType.value;
    }

    const sessionNotes = document.getElementById('modal_session_notes').value;

    if (!workTypeValue) {
        alert('근무 유형을 선택해주세요.');
        return;
    }

    // Disable buttons to prevent double submit
    document.getElementById('modalCompleteBtn').disabled = true;
    document.getElementById('modalCancelBtn').disabled = true;

    fetch('{{ url_for("complete_session_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            schedule_id: currentScheduleId,
            work_type: workTypeValue,
            session_notes: sessionNotes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '수업 완료 처리에 실패했습니다.');
            document.getElementById('modalCompleteBtn').disabled = false;
            document.getElementById('modalCancelBtn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('수업 완료 처리 중 오류가 발생했습니다.');
        document.getElementById('modalCompleteBtn').disabled = false;
        document.getElementById('modalCancelBtn').disabled = false;
    });
}

function submitCancelSession() {
    if (!confirm('이 수업을 취소하시겠습니까?')) {
        return;
    }

    // Disable buttons to prevent double submit
    document.getElementById('modalCompleteBtn').disabled = true;
    document.getElementById('modalCancelBtn').disabled = true;

    fetch('{{ url_for("cancel_session_ajax") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            schedule_id: currentScheduleId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '수업 취소에 실패했습니다.');
            document.getElementById('modalCompleteBtn').disabled = false;
            document.getElementById('modalCancelBtn').disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('수업 취소 중 오류가 발생했습니다.');
        document.getElementById('modalCompleteBtn').disabled = false;
        document.getElementById('modalCancelBtn').disabled = false;
    });
}

// ===== Admin Edit Modal Functions (admin only) =====
let editScheduleId = null;

function openEditModal(scheduleId, memberName, scheduleDate, startTime, currentStatus, currentWorkType) {
    editScheduleId = scheduleId;

    // Populate modal info
    document.getElementById('editModalMemberName').textContent = memberName;
    document.getElementById('editModalScheduleDate').textContent = scheduleDate;
    document.getElementById('editModalScheduleTime').textContent = startTime;

    // Set current status
    document.getElementById('editStatus').value = currentStatus;

    // Set current work type if exists
    if (currentWorkType) {
        document.getElementById('editWorkType').value = currentWorkType;
    } else {
        document.getElementById('editWorkType').value = '근무내';
    }

    // Show/hide work type based on status
    toggleWorkTypeField();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
    modal.show();
}

function toggleWorkTypeField() {
    const status = document.getElementById('editStatus').value;
    const workTypeGroup = document.getElementById('editWorkTypeGroup');
    if (status === '수업 완료') {
        workTypeGroup.style.display = 'block';
    } else {
        workTypeGroup.style.display = 'none';
    }
}

function submitEditSchedule() {
    const status = document.getElementById('editStatus').value;
    const workType = document.getElementById('editWorkType').value;
    const btn = document.getElementById('editSaveBtn');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch('{{ url_for("edit_schedule_status") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            schedule_id: editScheduleId,
            status: status,
            work_type: workType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '상태 변경에 실패했습니다.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> 저장';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('상태 변경 중 오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save"></i> 저장';
    });
}
</script>

<!-- Session Complete Modal -->
<div class="modal fade" id="completeSessionModal" tabindex="-1" aria-labelledby="completeSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeSessionModalLabel">수업 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Session Info -->
                <div class="alert alert-info mb-3">
                    <div class="row">
                        <div class="col-6">
                            <strong>회원명:</strong> <span id="modalMemberName"></span>
                        </div>
                        <div class="col-6">
                            <strong>날짜:</strong> <span id="modalScheduleDate"></span>
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="col-12">
                            <strong>시간:</strong> <span id="modalScheduleTime"></span>
                        </div>
                    </div>
                </div>

                <!-- Work Type Selection (Manual - for weekends or when working hours not set) -->
                <div class="mb-3" id="workTypeSelection">
                    <label class="form-label"><strong>근무 유형 *</strong></label>
                    <div class="d-flex gap-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="modal_work_type"
                                   id="modalWorkTypeIn" value="근무내">
                            <label class="form-check-label btn btn-outline-primary px-4 py-2" for="modalWorkTypeIn">
                                Main
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="modal_work_type"
                                   id="modalWorkTypeOut" value="근무외">
                            <label class="form-check-label btn btn-outline-secondary px-4 py-2" for="modalWorkTypeOut">
                                그 외
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Work Type Auto Display (for weekdays with working hours set) -->
                <div class="mb-3" id="workTypeAutoDisplay" style="display: none;">
                    <label class="form-label"><strong>근무 유형</strong></label>
                    <div class="alert alert-secondary py-2 mb-1">
                        <span id="autoWorkTypeValue" class="fw-bold"></span>
                        <small class="text-muted ms-2">(수업 시간 기준 자동 분류)</small>
                    </div>
                    <input type="hidden" id="autoWorkTypeHidden" value="">
                    <small class="text-muted">평일은 근무시간에 따라 자동 분류됩니다.</small>
                </div>

                <!-- Session Notes -->
                <div class="mb-3">
                    <label class="form-label"><strong>수업 일지</strong> <small class="text-muted">(선택사항)</small></label>
                    <textarea class="form-control" id="modal_session_notes" rows="3" placeholder="수업 내용, 회원 상태, 특이사항 등을 기록하세요..."></textarea>
                </div>

                <!-- Info about member signature -->
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    <small>수업 확인 후 회원이 본인 계정에서 서명을 완료하면 수업이 최종 완료됩니다.</small>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-outline-danger" id="modalCancelBtn" onclick="submitCancelSession()">
                    <i class="bi bi-x-circle"></i> 수업 취소
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-success" id="modalCompleteBtn" onclick="submitCompleteSession()">
                        <i class="bi bi-check-circle"></i> 수업 확인
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Edit Schedule Modal (admin only) -->
{% if user.role in ['main_admin', 'branch_admin'] %}
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="editScheduleModalLabel">
                    <i class="bi bi-pencil-square"></i> 스케줄 수정
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Schedule Info -->
                <div class="alert alert-secondary py-2 mb-3">
                    <small>
                        <strong>회원:</strong> <span id="editModalMemberName"></span><br>
                        <strong>날짜:</strong> <span id="editModalScheduleDate"></span><br>
                        <strong>시간:</strong> <span id="editModalScheduleTime"></span>
                    </small>
                </div>

                <!-- Status Selection -->
                <div class="mb-3">
                    <label class="form-label"><strong>상태</strong></label>
                    <select class="form-select" id="editStatus" onchange="toggleWorkTypeField()">
                        <option value="수업 계획">수업 계획</option>
                        <option value="수업 완료">수업 완료</option>
                        <option value="수업 취소">수업 취소</option>
                    </select>
                </div>

                <!-- Work Type (shown only when status is 수업 완료) -->
                <div class="mb-3" id="editWorkTypeGroup" style="display: none;">
                    <label class="form-label"><strong>근무 유형</strong></label>
                    <select class="form-select" id="editWorkType">
                        <option value="근무내">Main (근무내)</option>
                        <option value="근무외">그 외 (근무외)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm" id="editSaveBtn" onclick="submitEditSchedule()">
                    <i class="bi bi-save"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- OT Extension Popup (for trainers with near-deadline OTs) -->
{% if user.role == 'trainer' and near_deadline_ots %}
<div class="modal fade" id="otExtensionModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>OT 기한 만료 임박
                </h5>
            </div>
            <div class="modal-body">
                <p class="mb-3">다음 OT 배정이 곧 만료됩니다. 연장하시겠습니까?</p>
                <div id="nearDeadlineOtList">
                    {% for ot in near_deadline_ots %}
                    <div class="card mb-2 near-deadline-card" data-assignment-id="{{ ot.id }}">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ ot.member.member_name }}</strong>
                                    <span class="badge {% if ot.session_number == 1 %}bg-success{% elif ot.session_number == 2 %}bg-primary{% else %}bg-warning text-dark{% endif %} ms-1">
                                        {{ ot.session_number }}차
                                    </span>
                                </div>
                                <div>
                                    <span class="badge bg-danger">
                                        {% if ot.days_remaining == 0 %}오늘 만료!{% else %}{{ ot.days_remaining }}일 남음{% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="mt-2 d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-success flex-grow-1"
                                        onclick="extendOtAssignment('{{ ot.id }}', this)">
                                    <i class="bi bi-calendar-plus"></i> 1주 연장
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        onclick="skipExtension('{{ ot.id }}', this)">
                                    연장 안함
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="alert alert-info py-2 mt-3 mb-0">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        연장은 1회만 가능합니다. 연장하지 않으면 기한 만료 시 자동으로 지점장에게 반환됩니다.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeExtensionModal">
                    나중에 결정
                </button>
            </div>
        </div>
    </div>
</div>
<script>
// Show extension popup on page load if there are near-deadline OTs
document.addEventListener('DOMContentLoaded', function() {
    // Check if already shown this session
    const shownThisSession = sessionStorage.getItem('otExtensionShown');
    if (!shownThisSession) {
        const modal = new bootstrap.Modal(document.getElementById('otExtensionModal'));
        modal.show();
        sessionStorage.setItem('otExtensionShown', 'true');
    }
});

function extendOtAssignment(assignmentId, btn) {
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch(`/ot-assignments/${assignmentId}/extend`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const card = btn.closest('.near-deadline-card');
            card.innerHTML = `
                <div class="card-body py-2 bg-success bg-opacity-10">
                    <div class="text-success">
                        <i class="bi bi-check-circle me-1"></i> ${data.message}
                    </div>
                </div>
            `;
            checkAllDecided();
        } else {
            alert(data.error || '연장에 실패했습니다.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-calendar-plus"></i> 1주 연장';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('연장 중 오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-calendar-plus"></i> 1주 연장';
    });
}

function skipExtension(assignmentId, btn) {
    const card = btn.closest('.near-deadline-card');
    card.innerHTML = `
        <div class="card-body py-2 bg-secondary bg-opacity-10">
            <div class="text-muted">
                <i class="bi bi-x-circle me-1"></i> 연장하지 않음 - 기한 만료 시 자동 반환됩니다.
            </div>
        </div>
    `;
    checkAllDecided();
}

function checkAllDecided() {
    const remainingCards = document.querySelectorAll('.near-deadline-card button');
    if (remainingCards.length === 0) {
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('otExtensionModal')).hide();
            location.reload();
        }, 1500);
    }
}
</script>
{% endif %}

<style>
/* Modal Styles */
#completeSessionModal .form-check-inline .form-check-input {
    display: none;
}
#completeSessionModal .form-check-inline .form-check-input:checked + .form-check-label {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
#completeSessionModal .form-check-inline .form-check-input[value="근무외"]:checked + .form-check-label {
    background-color: #6c757d;
    border-color: #6c757d;
}
#completeSessionModal .signature-container {
    background-color: #f8f9fa;
}
.schedule-status.status-confirmed {
    background-color: #0d6efd;
    color: #fff;
}
</style>

<!-- OT Option Modal (when clicking OT assignment) -->
{% if user.role == 'trainer' %}
<div class="modal fade" id="otOptionModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0" style="background-color: #475569;">
                <h6 class="modal-title text-white">
                    <i class="bi bi-person-badge me-2"></i>OT 회원 관리
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
                <div class="text-center mb-4">
                    <div class="bg-light rounded-3 p-3">
                        <h5 class="mb-1 text-dark" id="otOptionMemberName">회원명</h5>
                        <span class="badge bg-primary" id="otOptionSessionNumber">1차</span>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-lg btn-primary" id="otOptionScheduleBtn" onclick="otOptionSchedule()">
                        <i class="bi bi-calendar-event me-2"></i>스케줄 등록하기
                    </button>
                    <button type="button" class="btn btn-lg btn-outline-secondary" id="otOptionExtendBtn" onclick="otOptionExtend()">
                        <i class="bi bi-calendar-plus me-2"></i>1주일 연기하기
                    </button>
                </div>

                <p class="text-muted small text-center mt-3 mb-0">
                    <i class="bi bi-info-circle me-1"></i>연기는 1회만 가능합니다
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
