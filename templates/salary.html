{% extends 'base.html' %}

{% block content %}
<style>
.tier-table {
    font-size: 0.75rem;
}
.tier-table th, .tier-table td {
    padding: 0.25rem 0.35rem;
}
.tier-card .card-header {
    padding: 0.35rem 0.6rem;
}
.tier-card .card-header h6 {
    font-size: 0.8rem;
}
.tier-card .card-body {
    padding: 0.4rem !important;
}
.tier-card small {
    font-size: 0.65rem;
}
.salary-breakdown {
    font-size: 0.85rem;
    max-width: 400px;
    margin: 0 auto;
}
.salary-breakdown td, .salary-breakdown th {
    padding: 0.3rem 0.6rem;
}
.salary-breakdown .card-header {
    padding: 0.4rem 0.6rem;
}
.salary-breakdown .card-header h6 {
    font-size: 0.9rem;
}
.sales-display {
    font-size: 0.85rem;
    max-width: 400px;
    margin: 0 auto;
}
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>급여 관리</h2>
</div>

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="GET" id="filterForm" class="row align-items-center g-2">
            <div class="col-auto">
                <label class="col-form-label">월 선택:</label>
            </div>
            <div class="col-auto">
                <input type="month" name="month" class="form-control form-control-sm"
                       value="{{ selected_month }}" onchange="this.form.submit()">
            </div>
            {% if user.role == 'main_admin' and branches %}
            <div class="col-auto">
                <label class="col-form-label ms-3">지점:</label>
            </div>
            <div class="col-auto">
                <select name="branch_id" id="branchSelect" class="form-select form-select-sm" onchange="filterByBranch()">
                    <option value="">지점 선택</option>
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if filter_branch_id == branch.id %}selected{% endif %}>
                        {{ branch.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            {% if user.role != 'trainer' %}
            <div class="col-auto">
                <label class="col-form-label ms-3">트레이너:</label>
            </div>
            <div class="col-auto">
                <select name="trainer_id" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">트레이너 선택</option>
                    {% for trainer in trainers %}
                    <option value="{{ trainer.id }}" {% if selected_trainer_id == trainer.id %}selected{% endif %}>
                        {{ trainer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </form>
    </div>
</div>

{% if user.role == 'main_admin' %}
<script>
// Reset trainer when branch changes
function filterByBranch() {
    const trainerSelect = document.querySelector('select[name="trainer_id"]');
    if (trainerSelect) {
        trainerSelect.value = ''; // Reset trainer selection
    }
    document.getElementById('filterForm').submit();
}
</script>
{% endif %}

{% if user.role == 'trainer' %}
    {% set my_sales = trainers[0].sales if trainers else 0 %}
    {% set my_six_month = trainers[0].six_month_sales if trainers else 0 %}
{% elif selected_trainer %}
    {% set my_sales = selected_trainer.sales %}
    {% set my_six_month = selected_trainer.six_month_sales %}
{% else %}
    {% set my_sales = none %}
    {% set my_six_month = none %}
{% endif %}

<!-- Row 1: 수업당 인센 + 진급조건 + 수업료 (근무외) -->
{% set my_class_count = selected_trainer.class_count if selected_trainer else (trainers[0].class_count if trainers else 0) %}
<div class="row mb-2">
    <!-- 수업당 인센 Table -->
    <div class="col-md-5">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">수업당 인센</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="classIncentiveTable">
                        <thead>
                            <tr class="table-secondary">
                                <th>수업 수</th>
                                <th>30개 이상</th>
                                <th>50개 이상</th>
                                <th>70개 이상</th>
                                <th>100개 이상</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="table-secondary fw-bold">인센</td>
                                {% if my_sales is not none and my_class_count is not none %}
                                    {% set class_incentive_eligible = my_sales > 3000000 %}
                                    <td class="{% if class_incentive_eligible and my_class_count >= 30 and my_class_count < 50 %}table-success fw-bold{% endif %}">₩400,000</td>
                                    <td class="{% if class_incentive_eligible and my_class_count >= 50 and my_class_count < 70 %}table-success fw-bold{% endif %}">₩600,000</td>
                                    <td class="{% if class_incentive_eligible and my_class_count >= 70 and my_class_count < 100 %}table-success fw-bold{% endif %}">₩800,000</td>
                                    <td class="{% if class_incentive_eligible and my_class_count >= 100 %}table-success fw-bold{% endif %}">₩1,000,000</td>
                                {% else %}
                                    <td>₩400,000</td>
                                    <td>₩600,000</td>
                                    <td>₩800,000</td>
                                    <td>₩1,000,000</td>
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                </div>
                <small class="text-muted mt-2 d-block">* 매출 300만원 이하 일시 수업 갯수 인센 적용 안됨</small>
            </div>
        </div>
    </div>

    <!-- Master Trainer Tier Table -->
    <div class="col-md-4">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">진급 조건 (Master Trainer)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="masterTable">
                        <thead>
                            <tr class="table-secondary">
                                <th>6개월 평균</th>
                                <th>보너스</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set avg_sales = (my_six_month / 6)|int if my_six_month is not none else none %}
                            <tr>
                                <td class="{% if avg_sales is not none and avg_sales < salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-threshold">{{ "{:,}".format(salary_settings.master_threshold) }}</span> 미만</td>
                                <td class="{% if avg_sales is not none and avg_sales < salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-bonus" data-tier="0">₩0</span></td>
                            </tr>
                            <tr>
                                <td class="{% if avg_sales is not none and avg_sales >= salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-threshold">{{ "{:,}".format(salary_settings.master_threshold) }}</span> 이상</td>
                                <td class="{% if avg_sales is not none and avg_sales >= salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-bonus" data-tier="1">₩{{ "{:,}".format(salary_settings.master_bonus) }}</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 수업료 근무외 -->
    <div class="col-md-3">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">수업료 (근무외)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="lessonFeeOtherTable">
                        <thead>
                            <tr class="table-secondary">
                                <th>매출</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="{% if my_sales is not none and my_sales <= salary_settings.other_threshold %}table-success fw-bold{% endif %}"><span class="other-threshold">{{ "{:,}".format(salary_settings.other_threshold) }}</span> 이하</td>
                                <td class="{% if my_sales is not none and my_sales <= salary_settings.other_threshold %}table-success fw-bold{% endif %}">근무내 동일</td>
                            </tr>
                            <tr>
                                <td class="{% if my_sales is not none and my_sales > salary_settings.other_threshold %}table-success fw-bold{% endif %}"><span class="other-threshold">{{ "{:,}".format(salary_settings.other_threshold) }}</span> 초과</td>
                                <td class="{% if my_sales is not none and my_sales > salary_settings.other_threshold %}table-success fw-bold{% endif %}"><span class="other-rate">{{ salary_settings.other_rate }}%</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Row 2: 트레이너 인센티브 -->
<div class="row mb-2">
    <div class="col-12">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">트레이너 인센티브</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="incentiveTable">
                        <thead>
                            <tr class="table-secondary">
                                <th style="min-width: 50px;">매출</th>
                                <th>450만 미만</th>
                                <th>450만 이상</th>
                                <th>650만 이상</th>
                                <th>800만 이상</th>
                                <th>1,000만 이상</th>
                                <th>1,200만 이상</th>
                                <th>1,500만 이상</th>
                                <th>2,000만 이상</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="table-secondary fw-bold">인센</td>
                                {% if my_sales is not none %}
                                    <td class="{% if my_sales < 4500000 %}table-success fw-bold{% endif %}">₩0</td>
                                    <td class="{% if my_sales >= 4500000 and my_sales < 6500000 %}table-success fw-bold{% endif %}">₩225,000</td>
                                    <td class="{% if my_sales >= 6500000 and my_sales < 8000000 %}table-success fw-bold{% endif %}">₩520,000</td>
                                    <td class="{% if my_sales >= 8000000 and my_sales < 10000000 %}table-success fw-bold{% endif %}">₩880,000</td>
                                    <td class="{% if my_sales >= 10000000 and my_sales < 12000000 %}table-success fw-bold{% endif %}">₩1,400,000</td>
                                    <td class="{% if my_sales >= 12000000 and my_sales < 15000000 %}table-success fw-bold{% endif %}">매출 17%</td>
                                    <td class="{% if my_sales >= 15000000 and my_sales < 20000000 %}table-success fw-bold{% endif %}">17% + ₩500,000</td>
                                    <td class="{% if my_sales >= 20000000 %}table-success fw-bold{% endif %}">17% + ₩1,000,000</td>
                                {% else %}
                                    <td>₩0</td>
                                    <td>₩225,000</td>
                                    <td>₩520,000</td>
                                    <td>₩880,000</td>
                                    <td>₩1,400,000</td>
                                    <td>매출 17%</td>
                                    <td>17% + ₩500,000</td>
                                    <td>17% + ₩1,000,000</td>
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                </div>
                <small class="text-muted mt-2 d-block">* 매출 = 해당 월에 등록된 회원들의 총 계약금액 (세션 수 x 단가)</small>
            </div>
        </div>
    </div>
</div>

<!-- Row 3: 수업료 근무내 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">수업료 (근무내)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="lessonFeeTable">
                        <thead>
                            <tr class="table-secondary">
                                <th style="min-width: 50px;">매출</th>
                                <th>300만 미만</th>
                                <th>300만 이상</th>
                                <th>450만 이상</th>
                                <th>650만 이상</th>
                                <th>800만 이상</th>
                                <th>1,000만 이상</th>
                                <th>1,200만 이상</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="table-secondary fw-bold">%</td>
                                {% if my_sales is not none %}
                                    <td class="{% if my_sales < 3000000 %}table-success fw-bold{% endif %}">10%</td>
                                    <td class="{% if my_sales >= 3000000 and my_sales < 4500000 %}table-success fw-bold{% endif %}">30%</td>
                                    <td class="{% if my_sales >= 4500000 and my_sales < 6500000 %}table-success fw-bold{% endif %}">31%</td>
                                    <td class="{% if my_sales >= 6500000 and my_sales < 8000000 %}table-success fw-bold{% endif %}">32%</td>
                                    <td class="{% if my_sales >= 8000000 and my_sales < 10000000 %}table-success fw-bold{% endif %}">33%</td>
                                    <td class="{% if my_sales >= 10000000 and my_sales < 12000000 %}table-success fw-bold{% endif %}">34%</td>
                                    <td class="{% if my_sales >= 12000000 %}table-success fw-bold{% endif %}">35%</td>
                                {% else %}
                                    <td>10%</td>
                                    <td>30%</td>
                                    <td>31%</td>
                                    <td>32%</td>
                                    <td>33%</td>
                                    <td>34%</td>
                                    <td>35%</td>
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Row 4: OT 인센티브 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">OT 인센티브</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info py-2 mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>OT 10개 이상부터 1개당 5,000원</strong>
                    <br>
                    <small class="text-muted">해당 월에 완료한 OT 회원 수업이 10개를 초과하면 1개당 5,000원의 인센티브가 지급됩니다.</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% if user.role == 'trainer' %}
<!-- Trainer's Salary Breakdown -->
{% if trainers %}
{% set trainer = trainers[0] %}
{% set tax = (trainer.total_salary * 0.033)|int %}
{% set final_salary = trainer.total_salary - tax %}

<!-- 매출 Display -->
<div class="card mb-2 sales-display">
    <div class="card-body py-2 d-flex justify-content-between align-items-center bg-primary bg-opacity-10">
        <span class="fw-bold text-primary">{{ selected_month }} 이번 달 매출</span>
        <span class="fw-bold text-primary fs-6">₩{{ "{:,}".format(trainer.sales) }}</span>
    </div>
</div>

<div class="card salary-breakdown">
    <div class="card-header">
        <h6 class="mb-0">{{ selected_month }} 급여</h6>
    </div>
    <div class="card-body p-0">
        <table class="table table-bordered mb-0 table-sm">
            <tbody>
                <tr>
                    <td class="bg-light fw-bold" style="width: 160px;">트레이너 인센티브</td>
                    <td class="{% if trainer.incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.incentive) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업당 인센</td>
                    <td class="{% if trainer.class_incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.class_incentive) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">Master Trainer 보너스 <small class="text-muted">(6개월 평균: ₩{{ "{:,}".format((trainer.six_month_sales / 6)|int) }})</small></td>
                    <td class="{% if trainer.master_bonus > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.master_bonus) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무내) <small class="text-muted">{{ trainer.lesson_fee_rate_main }}%</small></td>
                    <td class="{% if trainer.lesson_fee_main > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.lesson_fee_main) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무외) <small class="text-muted">{{ trainer.lesson_fee_rate_other }}%</small></td>
                    <td class="{% if trainer.lesson_fee_other > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.lesson_fee_other) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">OT 인센티브 <small class="text-muted">({{ trainer.ot_session_count|default(0) }}개 완료{% if trainer.ot_session_count|default(0) < 10 %}, 10개 이상 시 지급{% endif %})</small></td>
                    <td class="{% if trainer.ot_incentive and trainer.ot_incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.ot_incentive|default(0)) }}</td>
                </tr>
                {% if trainer.refund_deduction and trainer.refund_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">환불 차감액</td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(trainer.refund_deduction) }}</td>
                </tr>
                {% endif %}
                {% if trainer.dayoff_deduction and trainer.dayoff_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">차감</td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(trainer.dayoff_deduction) }}</td>
                </tr>
                {% endif %}
                {% for adj in trainer.adjustments %}
                <tr>
                    <td class="bg-light fw-bold {{ 'text-danger' if adj.amount < 0 else 'text-success' }}">{{ adj.memo }}</td>
                    <td class="{{ 'text-danger' if adj.amount < 0 else 'text-success' }} fw-bold">{{ '-' if adj.amount < 0 else '' }}₩{{ "{:,}".format(adj.amount|abs) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-secondary">
                    <th>세전 급여</th>
                    <th>₩{{ "{:,}".format(trainer.total_salary) }}</th>
                </tr>
                <tr>
                    <td class="bg-light">세금 (3.3%)</td>
                    <td class="text-danger">-₩{{ "{:,}".format(tax) }}</td>
                </tr>
                <tr class="table-dark">
                    <th>최종 급여</th>
                    <th>₩{{ "{:,}".format(final_salary) }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endif %}

{% else %}
<!-- Admin/Manager View -->
{% if selected_trainer %}
{% set tax = (selected_trainer.total_salary * 0.033)|int %}
{% set final_salary = selected_trainer.total_salary - tax %}

<!-- 매출 Display -->
<div class="card mb-2 sales-display">
    <div class="card-body py-2 bg-primary bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-primary">{{ selected_trainer.name }} - {{ selected_month }} 이번 달 매출</span>
            <span class="fw-bold text-primary fs-6">₩{{ "{:,}".format(selected_trainer.sales) }}</span>
        </div>
        <div class="d-flex justify-content-end mt-2 gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#dayoffModal">
                <i class="bi bi-calendar-x"></i> 휴무일 수정
            </button>
            {% if user.role == 'main_admin' %}
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#adjustmentModal">
                <i class="bi bi-plus-circle"></i> 급여 조정
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Selected Trainer's Salary Breakdown -->
<div class="card mb-3 salary-breakdown">
    <div class="card-header">
        <h6 class="mb-0">{{ selected_trainer.name }} - {{ selected_month }} 급여</h6>
    </div>
    <div class="card-body p-0">
        <table class="table table-bordered mb-0 table-sm">
            <tbody>
                <tr>
                    <td class="bg-light fw-bold" style="width: 160px;">트레이너 인센티브</td>
                    <td class="{% if selected_trainer.incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.incentive) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업당 인센</td>
                    <td class="{% if selected_trainer.class_incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.class_incentive) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">Master Trainer 보너스 <small class="text-muted">(6개월 평균: ₩{{ "{:,}".format((selected_trainer.six_month_sales / 6)|int) }})</small></td>
                    <td class="{% if selected_trainer.master_bonus > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.master_bonus) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무내) <small class="text-muted">{{ selected_trainer.lesson_fee_rate_main }}%</small></td>
                    <td class="{% if selected_trainer.lesson_fee_main > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.lesson_fee_main) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무외) <small class="text-muted">{{ selected_trainer.lesson_fee_rate_other }}%</small></td>
                    <td class="{% if selected_trainer.lesson_fee_other > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.lesson_fee_other) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">OT 인센티브 <small class="text-muted">({{ selected_trainer.ot_session_count|default(0) }}개 완료{% if selected_trainer.ot_session_count|default(0) < 10 %}, 10개 이상 시 지급{% endif %})</small></td>
                    <td class="{% if selected_trainer.ot_incentive and selected_trainer.ot_incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.ot_incentive|default(0)) }}</td>
                </tr>
                {% if selected_trainer.refund_deduction and selected_trainer.refund_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">환불 차감액</td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(selected_trainer.refund_deduction) }}</td>
                </tr>
                {% endif %}
                {% if selected_trainer.dayoff_deduction and selected_trainer.dayoff_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">휴무 차감 <small class="text-muted">({{ selected_trainer.dayoff_days }}일)</small></td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(selected_trainer.dayoff_deduction) }}</td>
                </tr>
                {% endif %}
                {% for adj in selected_trainer.adjustments %}
                <tr>
                    <td class="bg-light fw-bold {{ 'text-danger' if adj.amount < 0 else 'text-success' }}">
                        {{ adj.memo }}
                        {% if user.role == 'main_admin' %}
                        <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-danger" onclick="deleteAdjustment('{{ adj.id }}')" title="삭제">
                            <i class="bi bi-x-circle"></i>
                        </button>
                        {% endif %}
                    </td>
                    <td class="{{ 'text-danger' if adj.amount < 0 else 'text-success' }} fw-bold">{{ '-' if adj.amount < 0 else '' }}₩{{ "{:,}".format(adj.amount|abs) }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="table-secondary">
                    <th>세전 급여</th>
                    <th id="preTaxSalaryDisplay">₩{{ "{:,}".format(selected_trainer.total_salary) }}</th>
                </tr>
                <tr>
                    <td class="bg-light">세금 (3.3%)</td>
                    <td class="text-danger" id="taxDisplay">-₩{{ "{:,}".format(tax) }}</td>
                </tr>
                <tr class="table-dark">
                    <th>최종 급여</th>
                    <th id="finalSalaryDisplay">₩{{ "{:,}".format(final_salary) }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- 휴무일 수정 Modal -->
<div class="modal fade" id="dayoffModal" tabindex="-1" aria-labelledby="dayoffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="dayoffModalLabel">휴무일 수정</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-2">{{ selected_trainer.name }} - {{ selected_month }}</p>
                <div class="mb-3">
                    <label class="form-label">휴무일 수</label>
                    <div class="input-group">
                        <input type="number" min="0" max="31" class="form-control" id="dayoffInput"
                               value="{{ selected_trainer.dayoff_days or 0 }}">
                        <span class="input-group-text">일</span>
                    </div>
                    <small class="text-muted">1일 무료, 이후 33,000원/일 차감</small>
                </div>
                <div class="alert alert-info py-2 mb-0" id="dayoffPreview">
                    <small>
                        <strong>차감 예상:</strong>
                        <span id="dayoffPreviewAmount">₩{{ "{:,}".format(selected_trainer.dayoff_deduction or 0) }}</span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveDayoffBtn" onclick="saveDayoff()">
                    <i class="bi bi-save"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

{% if user.role == 'main_admin' %}
<!-- 급여 조정 Modal -->
<div class="modal fade" id="adjustmentModal" tabindex="-1" aria-labelledby="adjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="adjustmentModalLabel">급여 조정 추가</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-2">{{ selected_trainer.name }} - {{ selected_month }}</p>
                <div class="mb-3">
                    <label class="form-label">금액</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="adjustmentAmount" placeholder="양수: 추가, 음수: 차감">
                        <span class="input-group-text">원</span>
                    </div>
                    <small class="text-muted">예: 보너스 100000, 차감 -50000</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">메모 (사유)</label>
                    <input type="text" class="form-control" id="adjustmentMemo" placeholder="예: 특별 보너스, 지각 차감 등">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveAdjustmentBtn" onclick="saveAdjustment()">
                    <i class="bi bi-save"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Preview dayoff deduction as user types
document.getElementById('dayoffInput').addEventListener('input', function() {
    const days = parseInt(this.value) || 0;
    const deduction = days <= 1 ? 0 : (days - 1) * 33000;
    document.getElementById('dayoffPreviewAmount').textContent = '₩' + deduction.toLocaleString();
});

function saveDayoff() {
    const trainerId = '{{ selected_trainer.id }}';
    const month = '{{ selected_month }}';
    const days = parseInt(document.getElementById('dayoffInput').value) || 0;
    const btn = document.getElementById('saveDayoffBtn');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch('/salary/dayoff/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            trainer_id: trainerId,
            month: month,
            days: days
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('오류: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> 저장';
        }
    })
    .catch(error => {
        alert('저장 중 오류가 발생했습니다.');
        console.error(error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save"></i> 저장';
    });
}

{% if user.role == 'main_admin' %}
function saveAdjustment() {
    const trainerId = '{{ selected_trainer.id }}';
    const month = '{{ selected_month }}';
    const amount = parseInt(document.getElementById('adjustmentAmount').value) || 0;
    const memo = document.getElementById('adjustmentMemo').value.trim();
    const btn = document.getElementById('saveAdjustmentBtn');

    if (amount === 0) {
        alert('금액을 입력해주세요.');
        return;
    }
    if (!memo) {
        alert('메모를 입력해주세요.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch('/salary/adjustment/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            trainer_id: trainerId,
            month: month,
            amount: amount,
            memo: memo
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('오류: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> 저장';
        }
    })
    .catch(error => {
        alert('저장 중 오류가 발생했습니다.');
        console.error(error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save"></i> 저장';
    });
}

function deleteAdjustment(adjustmentId) {
    if (!confirm('이 조정 항목을 삭제하시겠습니까?')) {
        return;
    }

    fetch('/salary/adjustment/delete/' + adjustmentId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('오류: ' + data.error);
        }
    })
    .catch(error => {
        alert('삭제 중 오류가 발생했습니다.');
        console.error(error);
    });
}
{% endif %}
</script>
{% else %}
<!-- Prompt to select trainer -->
<div class="card">
    <div class="card-body text-center py-5">
        <p class="text-muted mb-0">
            {% if user.role == 'main_admin' and not filter_branch_id %}
            지점과 트레이너를 선택해주세요.
            {% else %}
            트레이너를 선택해주세요.
            {% endif %}
        </p>
    </div>
</div>
{% endif %}
{% endif %}

{% endblock %}
