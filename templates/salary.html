{% extends 'base.html' %}

{% block content %}
<style>
.tier-table {
    font-size: 0.75rem;
}
.tier-table th, .tier-table td {
    padding: 0.25rem 0.35rem;
}
.tier-card .card-header {
    padding: 0.35rem 0.6rem;
}
.tier-card .card-header h6 {
    font-size: 0.8rem;
}
.tier-card .card-body {
    padding: 0.4rem !important;
}
.tier-card small {
    font-size: 0.65rem;
}
.salary-breakdown {
    font-size: 0.85rem;
    max-width: 400px;
    margin: 0 auto;
}
.salary-breakdown td, .salary-breakdown th {
    padding: 0.3rem 0.6rem;
}
.salary-breakdown .card-header {
    padding: 0.4rem 0.6rem;
}
.salary-breakdown .card-header h6 {
    font-size: 0.9rem;
}
.sales-display {
    font-size: 0.85rem;
    max-width: 400px;
    margin: 0 auto;
}
.tier-input {
    width: 80px;
    text-align: right;
    font-size: 0.7rem;
    padding: 0.15rem 0.3rem;
}
.tier-input-small {
    width: 50px;
    text-align: right;
    font-size: 0.7rem;
    padding: 0.15rem 0.3rem;
}
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>급여 관리</h2>
    {% if user.role == 'main_admin' %}
    <div>
        <button type="button" class="btn btn-outline-primary btn-sm" id="editTiersBtn" onclick="toggleEditMode()">
            <i class="bi bi-pencil"></i> 수정
        </button>
        <button type="button" class="btn btn-primary btn-sm d-none" id="saveTiersBtn" onclick="saveTiers()">
            <i class="bi bi-save"></i> 저장
        </button>
        <button type="button" class="btn btn-secondary btn-sm d-none" id="cancelTiersBtn" onclick="cancelEdit()">
            취소
        </button>
    </div>
    {% endif %}
</div>

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="GET" id="filterForm" class="row align-items-center g-2">
            <div class="col-auto">
                <label class="col-form-label">월 선택:</label>
            </div>
            <div class="col-auto">
                <input type="month" name="month" class="form-control form-control-sm"
                       value="{{ selected_month }}" onchange="this.form.submit()">
            </div>
            {% if user.role == 'main_admin' and branches %}
            <div class="col-auto">
                <label class="col-form-label ms-3">지점:</label>
            </div>
            <div class="col-auto">
                <select name="branch_id" id="branchSelect" class="form-select form-select-sm" onchange="filterByBranch()">
                    <option value="">지점 선택</option>
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if filter_branch_id == branch.id %}selected{% endif %}>
                        {{ branch.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            {% if user.role != 'trainer' %}
            <div class="col-auto">
                <label class="col-form-label ms-3">트레이너:</label>
            </div>
            <div class="col-auto">
                <select name="trainer_id" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">트레이너 선택</option>
                    {% for trainer in trainers %}
                    <option value="{{ trainer.id }}" {% if selected_trainer_id == trainer.id %}selected{% endif %}>
                        {{ trainer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </form>
    </div>
</div>

{% if user.role == 'main_admin' %}
<script>
// Reset trainer when branch changes
function filterByBranch() {
    const trainerSelect = document.querySelector('select[name="trainer_id"]');
    if (trainerSelect) {
        trainerSelect.value = ''; // Reset trainer selection
    }
    document.getElementById('filterForm').submit();
}
</script>
{% endif %}

{% if user.role == 'trainer' %}
    {% set my_sales = trainers[0].sales if trainers else 0 %}
    {% set my_six_month = trainers[0].six_month_sales if trainers else 0 %}
{% elif selected_trainer %}
    {% set my_sales = selected_trainer.sales %}
    {% set my_six_month = selected_trainer.six_month_sales %}
{% else %}
    {% set my_sales = none %}
    {% set my_six_month = none %}
{% endif %}

<!-- 트레이너 인센티브 and 진급조건 side by side -->
{% set tiers = salary_settings.incentive_tiers|reverse|list %}
<div class="row mb-2">
    <!-- Incentive Tier Table -->
    <div class="col-md-9">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">트레이너 인센티브</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="incentiveTable">
                        <thead>
                            <tr class="table-secondary">
                                <th style="min-width: 50px;">매출</th>
                                <th><span class="tier-threshold" data-tier="0">{{ "{:,}".format(tiers[0][0]) }}</span> 미만</th>
                                {% for tier in tiers %}
                                <th><span class="tier-threshold" data-tier="{{ loop.index }}">{{ "{:,}".format(tier[0]) }}</span></th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="table-secondary fw-bold">인센</td>
                                {% set avg_sales = (my_six_month / 6)|int if my_six_month is not none else none %}
                                {% if my_sales is not none %}
                                <td class="{% if my_sales < tiers[0][0] %}table-success fw-bold{% endif %}"><span class="tier-incentive" data-tier="0">₩0</span></td>
                                {% for tier in tiers %}
                                {% set next_threshold = tiers[loop.index][0] if loop.index < tiers|length else 999999999 %}
                                <td class="{% if my_sales >= tier[0] and my_sales < next_threshold %}table-success fw-bold{% endif %}"><span class="tier-incentive" data-tier="{{ loop.index }}">₩{{ "{:,}".format(tier[1]) }}</span></td>
                                {% endfor %}
                                {% else %}
                                <td><span class="tier-incentive" data-tier="0">₩0</span></td>
                                {% for tier in tiers %}
                                <td><span class="tier-incentive" data-tier="{{ loop.index }}">₩{{ "{:,}".format(tier[1]) }}</span></td>
                                {% endfor %}
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                </div>
                <small class="text-muted mt-2 d-block">* 매출 = 해당 월에 등록된 회원들의 총 계약금액 (세션 수 x 단가)</small>
            </div>
        </div>
    </div>

    <!-- Master Trainer Tier Table -->
    <div class="col-md-3">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">진급 조건 (Master Trainer)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="masterTable">
                        <thead>
                            <tr class="table-secondary">
                                <th>6개월 평균</th>
                                <th>보너스</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set avg_sales = (my_six_month / 6)|int if my_six_month is not none else none %}
                            <tr>
                                <td class="{% if avg_sales is not none and avg_sales < salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-threshold">{{ "{:,}".format(salary_settings.master_threshold) }}</span> 미만</td>
                                <td class="{% if avg_sales is not none and avg_sales < salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-bonus" data-tier="0">₩0</span></td>
                            </tr>
                            <tr>
                                <td class="{% if avg_sales is not none and avg_sales >= salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-threshold">{{ "{:,}".format(salary_settings.master_threshold) }}</span> 이상</td>
                                <td class="{% if avg_sales is not none and avg_sales >= salary_settings.master_threshold %}table-success fw-bold{% endif %}"><span class="master-bonus" data-tier="1">₩{{ "{:,}".format(salary_settings.master_bonus) }}</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 수업료 Tier Tables -->
{% set lesson_tiers = salary_settings.lesson_fee_tiers|reverse|list %}
<div class="row mb-3">
    <!-- 수업료 근무내 -->
    <div class="col-md-9">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">수업료 (근무내)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="lessonFeeTable">
                        <thead>
                            <tr class="table-secondary">
                                <th style="min-width: 50px;">매출</th>
                                <th><span class="lesson-threshold" data-tier="0">{{ "{:,}".format(lesson_tiers[0][0]) }}</span> 미만</th>
                                {% for tier in lesson_tiers %}
                                <th><span class="lesson-threshold" data-tier="{{ loop.index }}">{{ "{:,}".format(tier[0]) }}</span></th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="table-secondary fw-bold">%</td>
                                {% if my_sales is not none %}
                                <td class="{% if my_sales < lesson_tiers[0][0] %}table-success fw-bold{% endif %}"><span class="lesson-rate" data-tier="0">10%</span></td>
                                {% for tier in lesson_tiers %}
                                {% set next_threshold = lesson_tiers[loop.index][0] if loop.index < lesson_tiers|length else 999999999 %}
                                <td class="{% if my_sales >= tier[0] and my_sales < next_threshold %}table-success fw-bold{% endif %}"><span class="lesson-rate" data-tier="{{ loop.index }}">{{ tier[1] }}%</span></td>
                                {% endfor %}
                                {% else %}
                                <td><span class="lesson-rate" data-tier="0">10%</span></td>
                                {% for tier in lesson_tiers %}
                                <td><span class="lesson-rate" data-tier="{{ loop.index }}">{{ tier[1] }}%</span></td>
                                {% endfor %}
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- 수업료 근무외 -->
    <div class="col-md-3">
        <div class="card h-100 tier-card">
            <div class="card-header">
                <h6 class="mb-0">수업료 (근무외)</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm mb-0 text-center tier-table" id="lessonFeeOtherTable">
                        <thead>
                            <tr class="table-secondary">
                                <th>매출</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="{% if my_sales is not none and my_sales <= salary_settings.other_threshold %}table-success fw-bold{% endif %}"><span class="other-threshold">{{ "{:,}".format(salary_settings.other_threshold) }}</span> 이하</td>
                                <td class="{% if my_sales is not none and my_sales <= salary_settings.other_threshold %}table-success fw-bold{% endif %}">근무내 동일</td>
                            </tr>
                            <tr>
                                <td class="{% if my_sales is not none and my_sales > salary_settings.other_threshold %}table-success fw-bold{% endif %}"><span class="other-threshold">{{ "{:,}".format(salary_settings.other_threshold) }}</span> 초과</td>
                                <td class="{% if my_sales is not none and my_sales > salary_settings.other_threshold %}table-success fw-bold{% endif %}"><span class="other-rate">{{ salary_settings.other_rate }}%</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if user.role == 'trainer' %}
<!-- Trainer's Salary Breakdown -->
{% if trainers %}
{% set trainer = trainers[0] %}
{% set tax = (trainer.total_salary * 0.033)|int %}
{% set final_salary = trainer.total_salary - tax %}

<!-- 매출 Display -->
<div class="card mb-2 sales-display">
    <div class="card-body py-2 d-flex justify-content-between align-items-center bg-primary bg-opacity-10">
        <span class="fw-bold text-primary">{{ selected_month }} 이번 달 매출</span>
        <span class="fw-bold text-primary fs-6">₩{{ "{:,}".format(trainer.sales) }}</span>
    </div>
</div>

<div class="card salary-breakdown">
    <div class="card-header">
        <h6 class="mb-0">{{ selected_month }} 급여</h6>
    </div>
    <div class="card-body p-0">
        <table class="table table-bordered mb-0 table-sm">
            <tbody>
                <tr>
                    <td class="bg-light fw-bold" style="width: 160px;">트레이너 인센티브</td>
                    <td class="{% if trainer.incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.incentive) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">Master Trainer 보너스 <small class="text-muted">(6개월 평균: ₩{{ "{:,}".format((trainer.six_month_sales / 6)|int) }})</small></td>
                    <td class="{% if trainer.master_bonus > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.master_bonus) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무내) <small class="text-muted">{{ trainer.lesson_fee_rate_main }}%</small></td>
                    <td class="{% if trainer.lesson_fee_main > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.lesson_fee_main) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무외) <small class="text-muted">{{ trainer.lesson_fee_rate_other }}%</small></td>
                    <td class="{% if trainer.lesson_fee_other > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(trainer.lesson_fee_other) }}</td>
                </tr>
                {% if trainer.refund_deduction and trainer.refund_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">환불 차감액</td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(trainer.refund_deduction) }}</td>
                </tr>
                {% endif %}
                {% if trainer.dayoff_deduction and trainer.dayoff_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">차감</td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(trainer.dayoff_deduction) }}</td>
                </tr>
                {% endif %}
            </tbody>
            <tfoot>
                <tr class="table-secondary">
                    <th>세전 급여</th>
                    <th>₩{{ "{:,}".format(trainer.total_salary) }}</th>
                </tr>
                <tr>
                    <td class="bg-light">세금 (3.3%)</td>
                    <td class="text-danger">-₩{{ "{:,}".format(tax) }}</td>
                </tr>
                <tr class="table-dark">
                    <th>최종 급여</th>
                    <th>₩{{ "{:,}".format(final_salary) }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endif %}

{% else %}
<!-- Admin/Manager View -->
{% if selected_trainer %}
{% set tax = (selected_trainer.total_salary * 0.033)|int %}
{% set final_salary = selected_trainer.total_salary - tax %}

<!-- 매출 Display -->
<div class="card mb-2 sales-display">
    <div class="card-body py-2 bg-primary bg-opacity-10">
        <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-primary">{{ selected_trainer.name }} - {{ selected_month }} 이번 달 매출</span>
            <span class="fw-bold text-primary fs-6">₩{{ "{:,}".format(selected_trainer.sales) }}</span>
        </div>
        <div class="d-flex justify-content-end mt-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#dayoffModal">
                <i class="bi bi-calendar-x"></i> 휴무일 수정
            </button>
        </div>
    </div>
</div>

<!-- Selected Trainer's Salary Breakdown -->
<div class="card mb-3 salary-breakdown">
    <div class="card-header">
        <h6 class="mb-0">{{ selected_trainer.name }} - {{ selected_month }} 급여</h6>
    </div>
    <div class="card-body p-0">
        <table class="table table-bordered mb-0 table-sm">
            <tbody>
                <tr>
                    <td class="bg-light fw-bold" style="width: 160px;">트레이너 인센티브</td>
                    <td class="{% if selected_trainer.incentive > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.incentive) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">Master Trainer 보너스 <small class="text-muted">(6개월 평균: ₩{{ "{:,}".format((selected_trainer.six_month_sales / 6)|int) }})</small></td>
                    <td class="{% if selected_trainer.master_bonus > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.master_bonus) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무내) <small class="text-muted">{{ selected_trainer.lesson_fee_rate_main }}%</small></td>
                    <td class="{% if selected_trainer.lesson_fee_main > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.lesson_fee_main) }}</td>
                </tr>
                <tr>
                    <td class="bg-light fw-bold">수업료 (근무외) <small class="text-muted">{{ selected_trainer.lesson_fee_rate_other }}%</small></td>
                    <td class="{% if selected_trainer.lesson_fee_other > 0 %}text-success fw-bold{% endif %}">₩{{ "{:,}".format(selected_trainer.lesson_fee_other) }}</td>
                </tr>
                {% if selected_trainer.refund_deduction and selected_trainer.refund_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">환불 차감액</td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(selected_trainer.refund_deduction) }}</td>
                </tr>
                {% endif %}
                {% if selected_trainer.dayoff_deduction and selected_trainer.dayoff_deduction > 0 %}
                <tr>
                    <td class="bg-light fw-bold text-danger">휴무 차감 <small class="text-muted">({{ selected_trainer.dayoff_days }}일)</small></td>
                    <td class="text-danger fw-bold">-₩{{ "{:,}".format(selected_trainer.dayoff_deduction) }}</td>
                </tr>
                {% endif %}
            </tbody>
            <tfoot>
                <tr class="table-secondary">
                    <th>세전 급여</th>
                    <th id="preTaxSalaryDisplay">₩{{ "{:,}".format(selected_trainer.total_salary) }}</th>
                </tr>
                <tr>
                    <td class="bg-light">세금 (3.3%)</td>
                    <td class="text-danger" id="taxDisplay">-₩{{ "{:,}".format(tax) }}</td>
                </tr>
                <tr class="table-dark">
                    <th>최종 급여</th>
                    <th id="finalSalaryDisplay">₩{{ "{:,}".format(final_salary) }}</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- 휴무일 수정 Modal -->
<div class="modal fade" id="dayoffModal" tabindex="-1" aria-labelledby="dayoffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="dayoffModalLabel">휴무일 수정</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-2">{{ selected_trainer.name }} - {{ selected_month }}</p>
                <div class="mb-3">
                    <label class="form-label">휴무일 수</label>
                    <div class="input-group">
                        <input type="number" min="0" max="31" class="form-control" id="dayoffInput"
                               value="{{ selected_trainer.dayoff_days or 0 }}">
                        <span class="input-group-text">일</span>
                    </div>
                    <small class="text-muted">1일 무료, 이후 33,000원/일 차감</small>
                </div>
                <div class="alert alert-info py-2 mb-0" id="dayoffPreview">
                    <small>
                        <strong>차감 예상:</strong>
                        <span id="dayoffPreviewAmount">₩{{ "{:,}".format(selected_trainer.dayoff_deduction or 0) }}</span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveDayoffBtn" onclick="saveDayoff()">
                    <i class="bi bi-save"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Preview dayoff deduction as user types
document.getElementById('dayoffInput').addEventListener('input', function() {
    const days = parseInt(this.value) || 0;
    const deduction = days <= 1 ? 0 : (days - 1) * 33000;
    document.getElementById('dayoffPreviewAmount').textContent = '₩' + deduction.toLocaleString();
});

function saveDayoff() {
    const trainerId = '{{ selected_trainer.id }}';
    const month = '{{ selected_month }}';
    const days = parseInt(document.getElementById('dayoffInput').value) || 0;
    const btn = document.getElementById('saveDayoffBtn');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch('/salary/dayoff/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            trainer_id: trainerId,
            month: month,
            days: days
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('오류: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> 저장';
        }
    })
    .catch(error => {
        alert('저장 중 오류가 발생했습니다.');
        console.error(error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save"></i> 저장';
    });
}
</script>
{% else %}
<!-- Prompt to select trainer -->
<div class="card">
    <div class="card-body text-center py-5">
        <p class="text-muted mb-0">
            {% if user.role == 'main_admin' and not filter_branch_id %}
            지점과 트레이너를 선택해주세요.
            {% else %}
            트레이너를 선택해주세요.
            {% endif %}
        </p>
    </div>
</div>
{% endif %}
{% endif %}

{% if user.role == 'main_admin' %}
<script>
let isEditMode = false;
let originalValues = {};

function toggleEditMode() {
    isEditMode = true;
    document.getElementById('editTiersBtn').classList.add('d-none');
    document.getElementById('saveTiersBtn').classList.remove('d-none');
    document.getElementById('cancelTiersBtn').classList.remove('d-none');

    // Store original values and convert to inputs
    // Incentive thresholds
    document.querySelectorAll('.tier-threshold').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/,/g, ''));
        originalValues['threshold_' + i] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input" value="${value}" data-type="threshold" data-tier="${i}">`;
    });

    // Incentive values
    document.querySelectorAll('.tier-incentive').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/[₩,]/g, ''));
        originalValues['incentive_' + i] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input" value="${value}" data-type="incentive" data-tier="${i}">`;
    });

    // Master threshold (both rows)
    document.querySelectorAll('.master-threshold').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/,/g, ''));
        originalValues['master_threshold'] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input" value="${value}" data-type="master_threshold" data-index="${i}" style="width:70px;">`;
    });

    // Master bonus
    document.querySelectorAll('.master-bonus').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/[₩,]/g, ''));
        originalValues['master_bonus_' + i] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input" value="${value}" data-type="master_bonus" data-tier="${i}" style="width:70px;">`;
    });

    // Lesson fee thresholds
    document.querySelectorAll('.lesson-threshold').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/,/g, ''));
        originalValues['lesson_threshold_' + i] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input" value="${value}" data-type="lesson_threshold" data-tier="${i}">`;
    });

    // Lesson fee rates
    document.querySelectorAll('.lesson-rate').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/%/g, ''));
        originalValues['lesson_rate_' + i] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input-small" value="${value}" data-type="lesson_rate" data-tier="${i}">`;
    });

    // Other threshold (both rows)
    document.querySelectorAll('.other-threshold').forEach((el, i) => {
        const value = parseInt(el.textContent.replace(/,/g, ''));
        originalValues['other_threshold'] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input" value="${value}" data-type="other_threshold" data-index="${i}">`;
    });

    // Other rate
    document.querySelectorAll('.other-rate').forEach((el) => {
        const value = parseInt(el.textContent.replace(/%/g, ''));
        originalValues['other_rate'] = value;
        el.innerHTML = `<input type="number" class="form-control form-control-sm tier-input-small" value="${value}" data-type="other_rate">`;
    });

    // Sync threshold inputs
    syncThresholdInputs();
}

function syncThresholdInputs() {
    // Sync master threshold inputs
    document.querySelectorAll('input[data-type="master_threshold"]').forEach(input => {
        input.addEventListener('input', function() {
            document.querySelectorAll('input[data-type="master_threshold"]').forEach(other => {
                if (other !== this) other.value = this.value;
            });
        });
    });

    // Sync other threshold inputs
    document.querySelectorAll('input[data-type="other_threshold"]').forEach(input => {
        input.addEventListener('input', function() {
            document.querySelectorAll('input[data-type="other_threshold"]').forEach(other => {
                if (other !== this) other.value = this.value;
            });
        });
    });
}

function cancelEdit() {
    isEditMode = false;
    document.getElementById('editTiersBtn').classList.remove('d-none');
    document.getElementById('saveTiersBtn').classList.add('d-none');
    document.getElementById('cancelTiersBtn').classList.add('d-none');

    // Restore original values
    location.reload();
}

function saveTiers() {
    const data = {
        incentive_tiers: [],
        lesson_fee_tiers: [],
        master_threshold: 0,
        master_bonus: 0,
        other_threshold: 0,
        other_rate: 0
    };

    // Collect incentive tiers
    for (let i = 0; i < 9; i++) {
        const thresholdInput = document.querySelector(`input[data-type="threshold"][data-tier="${i}"]`);
        const incentiveInput = document.querySelector(`input[data-type="incentive"][data-tier="${i}"]`);
        const lessonThresholdInput = document.querySelector(`input[data-type="lesson_threshold"][data-tier="${i}"]`);
        const lessonRateInput = document.querySelector(`input[data-type="lesson_rate"][data-tier="${i}"]`);

        data.incentive_tiers.push({
            threshold: thresholdInput ? parseInt(thresholdInput.value) || 0 : 0,
            incentive: incentiveInput ? parseInt(incentiveInput.value) || 0 : 0
        });

        data.lesson_fee_tiers.push({
            threshold: lessonThresholdInput ? parseInt(lessonThresholdInput.value) || 0 : 0,
            rate: lessonRateInput ? parseInt(lessonRateInput.value) || 0 : 0
        });
    }

    // Collect master trainer data
    const masterThresholdInput = document.querySelector('input[data-type="master_threshold"]');
    const masterBonus1Input = document.querySelector('input[data-type="master_bonus"][data-tier="1"]');
    data.master_threshold = masterThresholdInput ? parseInt(masterThresholdInput.value) || 0 : 9000000;
    data.master_bonus = masterBonus1Input ? parseInt(masterBonus1Input.value) || 0 : 300000;

    // Collect other fee data
    const otherThresholdInput = document.querySelector('input[data-type="other_threshold"]');
    const otherRateInput = document.querySelector('input[data-type="other_rate"]');
    data.other_threshold = otherThresholdInput ? parseInt(otherThresholdInput.value) || 0 : 5000000;
    data.other_rate = otherRateInput ? parseInt(otherRateInput.value) || 0 : 40;

    const btn = document.getElementById('saveTiersBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 저장 중...';

    fetch('/salary/tiers/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('설정이 저장되었습니다.');
            location.reload();
        } else {
            alert('오류: ' + result.error);
        }
    })
    .catch(error => {
        alert('저장 중 오류가 발생했습니다: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-save"></i> 저장';
    });
}
</script>
{% endif %}

{% endblock %}
