{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>트레이너 관리</h2>
    <a href="{{ url_for('add_trainer') }}" class="btn btn-primary">+ 새 트레이너 등록</a>
</div>

{% if user.role == 'main_admin' and branches %}
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="GET" class="row align-items-center">
            <div class="col-auto">
                <label class="col-form-label">지점 필터:</label>
            </div>
            <div class="col-auto">
                <select name="branch_id" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">전체 지점</option>
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if selected_branch_id == branch.id %}selected{% endif %}>
                        {{ branch.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>이름</th>
                        <th>이메일</th>
                        <th>지점</th>
                        <th>근무시간</th>
                        <th>등록일</th>
                        {% if user.role == 'main_admin' %}
                        <th>상태</th>
                        {% endif %}
                        <th>회원</th>
                        {% if user.role == 'main_admin' %}
                        <th>관리</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for trainer in trainers %}
                    <tr class="{{ 'table-secondary' if trainer.status == '비활성화' else '' }}">
                        <td><strong>{{ trainer.name }}</strong></td>
                        <td>{{ trainer.email }}</td>
                        <td>{{ trainer.branch.name if trainer.branch else '-' }}</td>
                        <td>
                            {% if trainer.working_hours_start and trainer.working_hours_end %}
                            <span class="badge bg-info">{{ trainer.working_hours_start[:5] }} - {{ trainer.working_hours_end[:5] }}</span>
                            {% else %}
                            <span class="text-muted">미설정</span>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1"
                                    onclick="openWorkingHoursModal('{{ trainer.id }}', '{{ trainer.name }}', '{{ trainer.working_hours_start or '' }}', '{{ trainer.working_hours_end or '' }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                        <td>{{ trainer.created_at[:10] }}</td>
                        {% if user.role == 'main_admin' %}
                        <td>
                            <span class="badge {{ 'bg-success' if trainer.status != '비활성화' else 'bg-secondary' }}">
                                {{ trainer.status if trainer.status else '활성화' }}
                            </span>
                        </td>
                        {% endif %}
                        <td>
                            <a href="{{ url_for('members', trainer_id=trainer.id) }}" class="btn btn-sm btn-outline-primary">
                                회원 보기
                            </a>
                        </td>
                        {% if user.role == 'main_admin' %}
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <form method="POST" action="{{ url_for('toggle_user_status', user_id=trainer.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm {{ 'btn-warning' if trainer.status != '비활성화' else 'btn-success' }}"
                                            onclick="return confirm('{{ trainer.name }}님을 {{ '비활성화' if trainer.status != '비활성화' else '활성화' }} 하시겠습니까?')">
                                        {{ '비활성화' if trainer.status != '비활성화' else '활성화' }}
                                    </button>
                                </form>
                                <form method="POST" action="{{ url_for('delete_user', user_id=trainer.id) }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-danger"
                                            onclick="return confirm('정말로 {{ trainer.name }}님을 삭제하시겠습니까?\n\n⚠️ 배정된 모든 회원도 함께 삭제됩니다.\n이 작업은 되돌릴 수 없습니다.')">
                                        삭제
                                    </button>
                                </form>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="{{ 8 if user.role == 'main_admin' else 6 }}" class="text-center text-muted py-4">등록된 트레이너가 없습니다.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Working Hours Edit Modal -->
<div class="modal fade" id="workingHoursModal" tabindex="-1" aria-labelledby="workingHoursModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="workingHoursModalLabel">
                    <i class="bi bi-clock me-1"></i> 근무시간 설정
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">
                    <span id="modalTrainerName" class="fw-bold"></span>님의 근무시간
                </p>
                <input type="hidden" id="modalTrainerId">
                <div class="mb-3">
                    <label class="form-label">시작 시간</label>
                    <input type="time" class="form-control" id="workingHoursStart" step="3600">
                </div>
                <div class="mb-3">
                    <label class="form-label">종료 시간</label>
                    <input type="time" class="form-control" id="workingHoursEnd" step="3600">
                </div>
                <div class="alert alert-info py-2 small">
                    <i class="bi bi-info-circle me-1"></i>
                    평일(월~금) 근무시간 내 수업은 자동으로 Main으로 분류됩니다.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary btn-sm" id="saveWorkingHoursBtn" onclick="saveWorkingHours()">
                    저장
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let workingHoursModal = null;

document.addEventListener('DOMContentLoaded', function() {
    workingHoursModal = new bootstrap.Modal(document.getElementById('workingHoursModal'));
});

function openWorkingHoursModal(trainerId, trainerName, startTime, endTime) {
    document.getElementById('modalTrainerId').value = trainerId;
    document.getElementById('modalTrainerName').textContent = trainerName;
    document.getElementById('workingHoursStart').value = startTime ? startTime.substring(0, 5) : '';
    document.getElementById('workingHoursEnd').value = endTime ? endTime.substring(0, 5) : '';
    workingHoursModal.show();
}

function saveWorkingHours() {
    const trainerId = document.getElementById('modalTrainerId').value;
    const startTime = document.getElementById('workingHoursStart').value;
    const endTime = document.getElementById('workingHoursEnd').value;
    const btn = document.getElementById('saveWorkingHoursBtn');

    if (!startTime || !endTime) {
        alert('시작 시간과 종료 시간을 모두 입력해주세요.');
        return;
    }

    if (startTime >= endTime) {
        alert('종료 시간은 시작 시간보다 늦어야 합니다.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch(`/trainers/${trainerId}/working-hours`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            working_hours_start: startTime,
            working_hours_end: endTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || '저장에 실패했습니다.');
            btn.disabled = false;
            btn.innerHTML = '저장';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('저장 중 오류가 발생했습니다.');
        btn.disabled = false;
        btn.innerHTML = '저장';
    });
}
</script>
{% endblock %}
